// File: opl2.h/opl2.c
// Nuked OPL2 Emulator, adapted for Doom on MCU ports by Nicola Wrachien.
// This is atually an OPL2 emulator, with the bare minimum functionality for
// Doom.
// What's changed:
//  - Reduced number of voices and operators to match OPL2
//  - Some RAM savings by trimming the data size
//  - Percussion support was removed.
//  - Support for 11025 Hz sample rate
//  - Improved code for MCU speed. In particular for each operator we calculate
//    all the samples, and then they are summed at the end. Original code, for
//    each sample will iterate all the operators.
//  - heavy usage of tables.
//  Note: the sound will not be byte-exact even for original sample rate, because
//  of some optimizations, but the impact is negligible.
//
// Copyright (C) 2013-2018 Alexey Khokholov (Nuke.YKT) (original Nuked 3)
// Copyright (C) 2022-2023 Nicola Wrachien (next-hack) (Modifications for Doom)
//
// Original Copyright message follows:
//
// Copyright (C) 2013-2018 Alexey Khokholov (Nuke.YKT)
//
// This program is free software; you can redistribute it and/or
// modify it under the terms of the GNU General Public License
// as published by the Free Software Foundation; either version 2
// of the License, or (at your option) any later version.
//
// This program is distributed in the hope that it will be useful,
// but WITHOUT ANY WARRANTY; without even the implied warranty of
// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
// GNU General Public License for more details.
//
//
//  This is a cut down version of OPL2 emulator based on
//  Alexey Khokholov's Nuked OPL2 emulator, to be used for
//  MCU-Based Doom ports (e.g. Cortex M4/M33).
//  This is neither cycle exact, and many features are removed.
//  In particular:
//  - OPL2 support has been removed.
//  - Slots have been renumbered, but they appear with original address.
//  - Percussion has been removed. Not used in Doom.
//  - The original Nuked OPL2 calculated the stream as follow:
//        - for (sample = 0 to sampleNumber - 1
//              for (slot = 0 to 17)
//                  calculate Slot Output
//                  buffer[sample] =  buffer[sample] + slot Output
//    Instead, we swapped inner with outer loop operation, so that
//    it will be faster.
//  - The original Nuked OPL2 emulated what occurs in hardware.
//    This includes selective shift (like a PWM difference or multiplication)
//    in sums to achieve a fine regulation on attack/decay/release rates.
//    Instead we use floats (value calculated from application manual)
//    to achieve a similar effect.
//  - We use tables to know a-priori how many samples each phase will
//    last, so that we can skip checking every time if we need to change phase
//    (e.g. from attack to decay, from decay to sustain/release e from release
//    to OFF.
//  - If a slot is OFF we do not perform calculation, as its output is 0.
//
//  Original comments:
//  Nuked OPL2 emulator.
//  Thanks:
//      MAME Development Team(Jarek Burczynski, Tatsuyuki Satoh):
//          Feedback and Rhythm part calculation information.
//      forums.submarine.org.uk(carbon14, opl2):
//          Tremolo and phase generator calculation information.
//      OPLx decapsulated(Matthew Gambrell, Olli Niemitalo):
//          OPL2 ROMs.
//      siliconpr0n.org(John McMaster, digshadow):
//          YMF262 and VRC VII decaps and die shots.
//
// version: 1.8
//
#include <stdbool.h>
#include <stdio.h>
#include <stdlib.h>
#include <string.h>
#include "opl2.h"
#include "main.h"
#define printf(...)
#define KEYBOARD_ON_MODE2 1
#define DO_NOT_USE_SHIFT_TABLE 1
#pragma GCC optimize ("Ofast")  // we need to compile this code to be as fast as possible.

static struct _opl2_chip oplChip;
static struct _opl2_chip *chip = &oplChip;

#define RSM_FRAC    10
static const int32_t pm_tables[2][8][8] =
{
    // shifted by 1 bit
    {
        {0, 0, 0, 0, 0, 0, 0, 0},
        {0, 0, 0, 0, 0, 0, 0, 0},
        {0, 0, 1, 0, 0, 0, -1, 0},
        {0, 0, 1, 0, 0, 0, -1, 0},
        {0, 1, 2, 1, 0, -1, -2, -1},
        {0, 1, 2, 1, 0, -1, -2, -1},
        {0, 1, 3, 1, 0, -1, -3, -1},
        {0, 1, 3, 1, 0, -1, -3, -1},
    },
    // not shifted
    {
        {   0, 0, 0, 0, 0, 0, 0, 0},
        {   0, 0, 1, 0, 0, 0, -1, 0},
        {  0, 1, 2, 1, 0, -1, -2, -1},
        {  0, 1, 3, 1, 0, -1, -3, -1},
        {  0, 2, 4, 2, 0, -2, -4, -2},
        {  0, 2, 5, 2, 0, -2, -5, -2},
        {  0, 3, 6, 3, 0, -3, -6, -3},
        {  0, 3, 7, 3, 0, -3, -7, -3},
    }
};
// the LFO for vibrato should be 210-elements long. However, a 210 division is expensive.
// So we use a trick ...
const uint8_t resampled_lfo[2][256] =
{

        {
                0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,
                0, 0, 0, 0, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1,
                1, 1, 1, 1, 1, 1, 1, 1, 2, 2, 2, 2, 2, 2, 2, 2,
                2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 3, 3, 3, 3, 3,
                3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 4,
                4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4,
                4, 4, 5, 5, 5, 5, 5, 5, 5, 5, 5, 5, 5, 5, 5, 5,
                5, 5, 5, 5, 5, 5, 6, 6, 6, 6, 6, 6, 6, 6, 6, 6,
                6, 6, 6, 6, 6, 6, 6, 6, 6, 6, 6, 6, 6, 5, 5, 5,
                5, 5, 5, 5, 5, 5, 5, 5, 5, 5, 5, 5, 5, 5, 5, 5,
                4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4,
                4, 4, 4, 4, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3,
                3, 3, 3, 3, 3, 3, 3, 2, 2, 2, 2, 2, 2, 2, 2, 2,
                2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 1, 1, 1, 1, 1,
                1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 0, 0,
                0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,
        },
        {
                0, 0, 0, 0, 0, 1, 1, 1, 1, 1, 2, 2, 2, 2, 2, 3,
                3, 3, 3, 3, 4, 4, 4, 4, 4, 5, 5, 5, 5, 5, 6, 6,
                6, 6, 6, 7, 7, 7, 7, 7, 8, 8, 8, 8, 9, 9, 9, 9,
                9, 10, 10, 10, 10, 10, 11, 11, 11, 11, 11, 12, 12, 12, 12, 12,
                13, 13, 13, 13, 13, 14, 14, 14, 14, 14, 15, 15, 15, 15, 15, 16,
                16, 16, 16, 17, 17, 17, 17, 17, 18, 18, 18, 18, 18, 19, 19, 19,
                19, 19, 20, 20, 20, 20, 20, 21, 21, 21, 21, 21, 22, 22, 22, 22,
                22, 23, 23, 23, 23, 23, 24, 24, 24, 24, 25, 25, 25, 25, 25, 26,
                26, 26, 26, 25, 25, 25, 25, 25, 24, 24, 24, 24, 24, 23, 23, 23,
                23, 23, 22, 22, 22, 22, 21, 21, 21, 21, 21, 20, 20, 20, 20, 20,
                19, 19, 19, 19, 19, 18, 18, 18, 18, 18, 17, 17, 17, 17, 17, 16,
                16, 16, 16, 16, 15, 15, 15, 15, 15, 14, 14, 14, 14, 13, 13, 13,
                13, 13, 12, 12, 12, 12, 12, 11, 11, 11, 11, 11, 10, 10, 10, 10,
                10, 9, 9, 9, 9, 9, 8, 8, 8, 8, 8, 7, 7, 7, 7, 7,
                6, 6, 6, 6, 5, 5, 5, 5, 5, 4, 4, 4, 4, 4, 3, 3,
                3, 3, 3, 2, 2, 2, 2, 2, 1, 1, 1, 1, 1, 0, 0, 0,
        },
};

#if BETTER_COMPATIBILITY
static const uint16_t waveMask[4][4] =
{
    {0, 0, 0xFFFF, 0xFFFF},         // sine
    {0, 0, 1, 1},                   // half sine
    {0, 0, 0, 0},                   // |sine|
    {0, 1, 0, 1},                   // sawtooth
};
#else
static const int32_t waveMult[4][4] =
{
    {1, 1, -1, -1},       // sine
    {1, 1, 0, 0},         // half sine
    {1, 1, 1, 1},         // |sine|
    {1, 0, 1, 0},         // sawtooth
};
#endif
// Channel types

enum {
    ch_2op = 0,
    ch_4op = 1,
    ch_4op2 = 2,
    ch_drum = 3
};

// Envelope key types

enum {
    egk_norm = 0x01,
    egk_drum = 0x02
};


//
// logsin table
//

static const Bit16u logsinrom[512] =
{
    0x0859, 0x06c3, 0x0607, 0x058b, 0x052e, 0x04e4, 0x04a6, 0x0471,
    0x0443, 0x041a, 0x03f5, 0x03d3, 0x03b5, 0x0398, 0x037e, 0x0365,
    0x034e, 0x0339, 0x0324, 0x0311, 0x02ff, 0x02ed, 0x02dc, 0x02cd,
    0x02bd, 0x02af, 0x02a0, 0x0293, 0x0286, 0x0279, 0x026d, 0x0261,
    0x0256, 0x024b, 0x0240, 0x0236, 0x022c, 0x0222, 0x0218, 0x020f,
    0x0206, 0x01fd, 0x01f5, 0x01ec, 0x01e4, 0x01dc, 0x01d4, 0x01cd,
    0x01c5, 0x01be, 0x01b7, 0x01b0, 0x01a9, 0x01a2, 0x019b, 0x0195,
    0x018f, 0x0188, 0x0182, 0x017c, 0x0177, 0x0171, 0x016b, 0x0166,
    0x0160, 0x015b, 0x0155, 0x0150, 0x014b, 0x0146, 0x0141, 0x013c,
    0x0137, 0x0133, 0x012e, 0x0129, 0x0125, 0x0121, 0x011c, 0x0118,
    0x0114, 0x010f, 0x010b, 0x0107, 0x0103, 0x00ff, 0x00fb, 0x00f8,
    0x00f4, 0x00f0, 0x00ec, 0x00e9, 0x00e5, 0x00e2, 0x00de, 0x00db,
    0x00d7, 0x00d4, 0x00d1, 0x00cd, 0x00ca, 0x00c7, 0x00c4, 0x00c1,
    0x00be, 0x00bb, 0x00b8, 0x00b5, 0x00b2, 0x00af, 0x00ac, 0x00a9,
    0x00a7, 0x00a4, 0x00a1, 0x009f, 0x009c, 0x0099, 0x0097, 0x0094,
    0x0092, 0x008f, 0x008d, 0x008a, 0x0088, 0x0086, 0x0083, 0x0081,
    0x007f, 0x007d, 0x007a, 0x0078, 0x0076, 0x0074, 0x0072, 0x0070,
    0x006e, 0x006c, 0x006a, 0x0068, 0x0066, 0x0064, 0x0062, 0x0060,
    0x005e, 0x005c, 0x005b, 0x0059, 0x0057, 0x0055, 0x0053, 0x0052,
    0x0050, 0x004e, 0x004d, 0x004b, 0x004a, 0x0048, 0x0046, 0x0045,
    0x0043, 0x0042, 0x0040, 0x003f, 0x003e, 0x003c, 0x003b, 0x0039,
    0x0038, 0x0037, 0x0035, 0x0034, 0x0033, 0x0031, 0x0030, 0x002f,
    0x002e, 0x002d, 0x002b, 0x002a, 0x0029, 0x0028, 0x0027, 0x0026,
    0x0025, 0x0024, 0x0023, 0x0022, 0x0021, 0x0020, 0x001f, 0x001e,
    0x001d, 0x001c, 0x001b, 0x001a, 0x0019, 0x0018, 0x0017, 0x0017,
    0x0016, 0x0015, 0x0014, 0x0014, 0x0013, 0x0012, 0x0011, 0x0011,
    0x0010, 0x000f, 0x000f, 0x000e, 0x000d, 0x000d, 0x000c, 0x000c,
    0x000b, 0x000a, 0x000a, 0x0009, 0x0009, 0x0008, 0x0008, 0x0007,
    0x0007, 0x0007, 0x0006, 0x0006, 0x0005, 0x0005, 0x0005, 0x0004,
    0x0004, 0x0004, 0x0003, 0x0003, 0x0003, 0x0002, 0x0002, 0x0002,
    0x0002, 0x0001, 0x0001, 0x0001, 0x0001, 0x0001, 0x0001, 0x0001,
    0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000,
    0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000,
    0x0001, 0x0001, 0x0001, 0x0001, 0x0001, 0x0001, 0x0001, 0x0002,
    0x0002, 0x0002, 0x0002, 0x0003, 0x0003, 0x0003, 0x0004, 0x0004,
    0x0004, 0x0005, 0x0005, 0x0005, 0x0006, 0x0006, 0x0007, 0x0007,
    0x0007, 0x0008, 0x0008, 0x0009, 0x0009, 0x000a, 0x000a, 0x000b,
    0x000c, 0x000c, 0x000d, 0x000d, 0x000e, 0x000f, 0x000f, 0x0010,
    0x0011, 0x0011, 0x0012, 0x0013, 0x0014, 0x0014, 0x0015, 0x0016,
    0x0017, 0x0017, 0x0018, 0x0019, 0x001a, 0x001b, 0x001c, 0x001d,
    0x001e, 0x001f, 0x0020, 0x0021, 0x0022, 0x0023, 0x0024, 0x0025,
    0x0026, 0x0027, 0x0028, 0x0029, 0x002a, 0x002b, 0x002d, 0x002e,
    0x002f, 0x0030, 0x0031, 0x0033, 0x0034, 0x0035, 0x0037, 0x0038,
    0x0039, 0x003b, 0x003c, 0x003e, 0x003f, 0x0040, 0x0042, 0x0043,
    0x0045, 0x0046, 0x0048, 0x004a, 0x004b, 0x004d, 0x004e, 0x0050,
    0x0052, 0x0053, 0x0055, 0x0057, 0x0059, 0x005b, 0x005c, 0x005e,
    0x0060, 0x0062, 0x0064, 0x0066, 0x0068, 0x006a, 0x006c, 0x006e,
    0x0070, 0x0072, 0x0074, 0x0076, 0x0078, 0x007a, 0x007d, 0x007f,
    0x0081, 0x0083, 0x0086, 0x0088, 0x008a, 0x008d, 0x008f, 0x0092,
    0x0094, 0x0097, 0x0099, 0x009c, 0x009f, 0x00a1, 0x00a4, 0x00a7,
    0x00a9, 0x00ac, 0x00af, 0x00b2, 0x00b5, 0x00b8, 0x00bb, 0x00be,
    0x00c1, 0x00c4, 0x00c7, 0x00ca, 0x00cd, 0x00d1, 0x00d4, 0x00d7,
    0x00db, 0x00de, 0x00e2, 0x00e5, 0x00e9, 0x00ec, 0x00f0, 0x00f4,
    0x00f8, 0x00fb, 0x00ff, 0x0103, 0x0107, 0x010b, 0x010f, 0x0114,
    0x0118, 0x011c, 0x0121, 0x0125, 0x0129, 0x012e, 0x0133, 0x0137,
    0x013c, 0x0141, 0x0146, 0x014b, 0x0150, 0x0155, 0x015b, 0x0160,
    0x0166, 0x016b, 0x0171, 0x0177, 0x017c, 0x0182, 0x0188, 0x018f,
    0x0195, 0x019b, 0x01a2, 0x01a9, 0x01b0, 0x01b7, 0x01be, 0x01c5,
    0x01cd, 0x01d4, 0x01dc, 0x01e4, 0x01ec, 0x01f5, 0x01fd, 0x0206,
    0x020f, 0x0218, 0x0222, 0x022c, 0x0236, 0x0240, 0x024b, 0x0256,
    0x0261, 0x026d, 0x0279, 0x0286, 0x0293, 0x02a0, 0x02af, 0x02bd,
    0x02cd, 0x02dc, 0x02ed, 0x02ff, 0x0311, 0x0324, 0x0339, 0x034e,
    0x0365, 0x037e, 0x0398, 0x03b5, 0x03d3, 0x03f5, 0x041a, 0x0443,
    0x0471, 0x04a6, 0x04e4, 0x052e, 0x058b, 0x0607, 0x06c3, 0x0859,
};

//
// exp rom table. This is exprom[n] = 2048 * pow(2, n/256.0)
//
#if USE_OLD_EXP_TABLE
static const Bit16u exprom[256] = {
    0x7fa, 0x7f5, 0x7ef, 0x7ea, 0x7e4, 0x7df, 0x7da, 0x7d4,
    0x7cf, 0x7c9, 0x7c4, 0x7bf, 0x7b9, 0x7b4, 0x7ae, 0x7a9,
    0x7a4, 0x79f, 0x799, 0x794, 0x78f, 0x78a, 0x784, 0x77f,
    0x77a, 0x775, 0x770, 0x76a, 0x765, 0x760, 0x75b, 0x756,
    0x751, 0x74c, 0x747, 0x742, 0x73d, 0x738, 0x733, 0x72e,
    0x729, 0x724, 0x71f, 0x71a, 0x715, 0x710, 0x70b, 0x706,
    0x702, 0x6fd, 0x6f8, 0x6f3, 0x6ee, 0x6e9, 0x6e5, 0x6e0,
    0x6db, 0x6d6, 0x6d2, 0x6cd, 0x6c8, 0x6c4, 0x6bf, 0x6ba,
    0x6b5, 0x6b1, 0x6ac, 0x6a8, 0x6a3, 0x69e, 0x69a, 0x695,
    0x691, 0x68c, 0x688, 0x683, 0x67f, 0x67a, 0x676, 0x671,
    0x66d, 0x668, 0x664, 0x65f, 0x65b, 0x657, 0x652, 0x64e,
    0x649, 0x645, 0x641, 0x63c, 0x638, 0x634, 0x630, 0x62b,
    0x627, 0x623, 0x61e, 0x61a, 0x616, 0x612, 0x60e, 0x609,
    0x605, 0x601, 0x5fd, 0x5f9, 0x5f5, 0x5f0, 0x5ec, 0x5e8,
    0x5e4, 0x5e0, 0x5dc, 0x5d8, 0x5d4, 0x5d0, 0x5cc, 0x5c8,
    0x5c4, 0x5c0, 0x5bc, 0x5b8, 0x5b4, 0x5b0, 0x5ac, 0x5a8,
    0x5a4, 0x5a0, 0x59c, 0x599, 0x595, 0x591, 0x58d, 0x589,
    0x585, 0x581, 0x57e, 0x57a, 0x576, 0x572, 0x56f, 0x56b,
    0x567, 0x563, 0x560, 0x55c, 0x558, 0x554, 0x551, 0x54d,
    0x549, 0x546, 0x542, 0x53e, 0x53b, 0x537, 0x534, 0x530,
    0x52c, 0x529, 0x525, 0x522, 0x51e, 0x51b, 0x517, 0x514,
    0x510, 0x50c, 0x509, 0x506, 0x502, 0x4ff, 0x4fb, 0x4f8,
    0x4f4, 0x4f1, 0x4ed, 0x4ea, 0x4e7, 0x4e3, 0x4e0, 0x4dc,
    0x4d9, 0x4d6, 0x4d2, 0x4cf, 0x4cc, 0x4c8, 0x4c5, 0x4c2,
    0x4be, 0x4bb, 0x4b8, 0x4b5, 0x4b1, 0x4ae, 0x4ab, 0x4a8,
    0x4a4, 0x4a1, 0x49e, 0x49b, 0x498, 0x494, 0x491, 0x48e,
    0x48b, 0x488, 0x485, 0x482, 0x47e, 0x47b, 0x478, 0x475,
    0x472, 0x46f, 0x46c, 0x469, 0x466, 0x463, 0x460, 0x45d,
    0x45a, 0x457, 0x454, 0x451, 0x44e, 0x44b, 0x448, 0x445,
    0x442, 0x43f, 0x43c, 0x439, 0x436, 0x433, 0x430, 0x42d,
    0x42a, 0x428, 0x425, 0x422, 0x41f, 0x41c, 0x419, 0x416,
    0x414, 0x411, 0x40e, 0x40b, 0x408, 0x406, 0x403, 0x400
};
#else
static const uint16_t longExpTable[] =
{
        0xff4, 0xfea, 0xfde, 0xfd4, 0xfc8, 0xfbe, 0xfb4, 0xfa8, 0xf9e, 0xf92, 0xf88, 0xf7e, 0xf72, 0xf68, 0xf5c, 0xf52,
        0xf48, 0xf3e, 0xf32, 0xf28, 0xf1e, 0xf14, 0xf08, 0xefe, 0xef4, 0xeea, 0xee0, 0xed4, 0xeca, 0xec0, 0xeb6, 0xeac,
        0xea2, 0xe98, 0xe8e, 0xe84, 0xe7a, 0xe70, 0xe66, 0xe5c, 0xe52, 0xe48, 0xe3e, 0xe34, 0xe2a, 0xe20, 0xe16, 0xe0c,
        0xe04, 0xdfa, 0xdf0, 0xde6, 0xddc, 0xdd2, 0xdca, 0xdc0, 0xdb6, 0xdac, 0xda4, 0xd9a, 0xd90, 0xd88, 0xd7e, 0xd74,
        0xd6a, 0xd62, 0xd58, 0xd50, 0xd46, 0xd3c, 0xd34, 0xd2a, 0xd22, 0xd18, 0xd10, 0xd06, 0xcfe, 0xcf4, 0xcec, 0xce2,
        0xcda, 0xcd0, 0xcc8, 0xcbe, 0xcb6, 0xcae, 0xca4, 0xc9c, 0xc92, 0xc8a, 0xc82, 0xc78, 0xc70, 0xc68, 0xc60, 0xc56,
        0xc4e, 0xc46, 0xc3c, 0xc34, 0xc2c, 0xc24, 0xc1c, 0xc12, 0xc0a, 0xc02, 0xbfa, 0xbf2, 0xbea, 0xbe0, 0xbd8, 0xbd0,
        0xbc8, 0xbc0, 0xbb8, 0xbb0, 0xba8, 0xba0, 0xb98, 0xb90, 0xb88, 0xb80, 0xb78, 0xb70, 0xb68, 0xb60, 0xb58, 0xb50,
        0xb48, 0xb40, 0xb38, 0xb32, 0xb2a, 0xb22, 0xb1a, 0xb12, 0xb0a, 0xb02, 0xafc, 0xaf4, 0xaec, 0xae4, 0xade, 0xad6,
        0xace, 0xac6, 0xac0, 0xab8, 0xab0, 0xaa8, 0xaa2, 0xa9a, 0xa92, 0xa8c, 0xa84, 0xa7c, 0xa76, 0xa6e, 0xa68, 0xa60,
        0xa58, 0xa52, 0xa4a, 0xa44, 0xa3c, 0xa36, 0xa2e, 0xa28, 0xa20, 0xa18, 0xa12, 0xa0c, 0xa04, 0x9fe, 0x9f6, 0x9f0,
        0x9e8, 0x9e2, 0x9da, 0x9d4, 0x9ce, 0x9c6, 0x9c0, 0x9b8, 0x9b2, 0x9ac, 0x9a4, 0x99e, 0x998, 0x990, 0x98a, 0x984,
        0x97c, 0x976, 0x970, 0x96a, 0x962, 0x95c, 0x956, 0x950, 0x948, 0x942, 0x93c, 0x936, 0x930, 0x928, 0x922, 0x91c,
        0x916, 0x910, 0x90a, 0x904, 0x8fc, 0x8f6, 0x8f0, 0x8ea, 0x8e4, 0x8de, 0x8d8, 0x8d2, 0x8cc, 0x8c6, 0x8c0, 0x8ba,
        0x8b4, 0x8ae, 0x8a8, 0x8a2, 0x89c, 0x896, 0x890, 0x88a, 0x884, 0x87e, 0x878, 0x872, 0x86c, 0x866, 0x860, 0x85a,
        0x854, 0x850, 0x84a, 0x844, 0x83e, 0x838, 0x832, 0x82c, 0x828, 0x822, 0x81c, 0x816, 0x810, 0x80c, 0x806, 0x800,
        0x7fa, 0x7f5, 0x7ef, 0x7ea, 0x7e4, 0x7df, 0x7da, 0x7d4, 0x7cf, 0x7c9, 0x7c4, 0x7bf, 0x7b9, 0x7b4, 0x7ae, 0x7a9,
        0x7a4, 0x79f, 0x799, 0x794, 0x78f, 0x78a, 0x784, 0x77f, 0x77a, 0x775, 0x770, 0x76a, 0x765, 0x760, 0x75b, 0x756,
        0x751, 0x74c, 0x747, 0x742, 0x73d, 0x738, 0x733, 0x72e, 0x729, 0x724, 0x71f, 0x71a, 0x715, 0x710, 0x70b, 0x706,
        0x702, 0x6fd, 0x6f8, 0x6f3, 0x6ee, 0x6e9, 0x6e5, 0x6e0, 0x6db, 0x6d6, 0x6d2, 0x6cd, 0x6c8, 0x6c4, 0x6bf, 0x6ba,
        0x6b5, 0x6b1, 0x6ac, 0x6a8, 0x6a3, 0x69e, 0x69a, 0x695, 0x691, 0x68c, 0x688, 0x683, 0x67f, 0x67a, 0x676, 0x671,
        0x66d, 0x668, 0x664, 0x65f, 0x65b, 0x657, 0x652, 0x64e, 0x649, 0x645, 0x641, 0x63c, 0x638, 0x634, 0x630, 0x62b,
        0x627, 0x623, 0x61e, 0x61a, 0x616, 0x612, 0x60e, 0x609, 0x605, 0x601, 0x5fd, 0x5f9, 0x5f5, 0x5f0, 0x5ec, 0x5e8,
        0x5e4, 0x5e0, 0x5dc, 0x5d8, 0x5d4, 0x5d0, 0x5cc, 0x5c8, 0x5c4, 0x5c0, 0x5bc, 0x5b8, 0x5b4, 0x5b0, 0x5ac, 0x5a8,
        0x5a4, 0x5a0, 0x59c, 0x599, 0x595, 0x591, 0x58d, 0x589, 0x585, 0x581, 0x57e, 0x57a, 0x576, 0x572, 0x56f, 0x56b,
        0x567, 0x563, 0x560, 0x55c, 0x558, 0x554, 0x551, 0x54d, 0x549, 0x546, 0x542, 0x53e, 0x53b, 0x537, 0x534, 0x530,
        0x52c, 0x529, 0x525, 0x522, 0x51e, 0x51b, 0x517, 0x514, 0x510, 0x50c, 0x509, 0x506, 0x502, 0x4ff, 0x4fb, 0x4f8,
        0x4f4, 0x4f1, 0x4ed, 0x4ea, 0x4e7, 0x4e3, 0x4e0, 0x4dc, 0x4d9, 0x4d6, 0x4d2, 0x4cf, 0x4cc, 0x4c8, 0x4c5, 0x4c2,
        0x4be, 0x4bb, 0x4b8, 0x4b5, 0x4b1, 0x4ae, 0x4ab, 0x4a8, 0x4a4, 0x4a1, 0x49e, 0x49b, 0x498, 0x494, 0x491, 0x48e,
        0x48b, 0x488, 0x485, 0x482, 0x47e, 0x47b, 0x478, 0x475, 0x472, 0x46f, 0x46c, 0x469, 0x466, 0x463, 0x460, 0x45d,
        0x45a, 0x457, 0x454, 0x451, 0x44e, 0x44b, 0x448, 0x445, 0x442, 0x43f, 0x43c, 0x439, 0x436, 0x433, 0x430, 0x42d,
        0x42a, 0x428, 0x425, 0x422, 0x41f, 0x41c, 0x419, 0x416, 0x414, 0x411, 0x40e, 0x40b, 0x408, 0x406, 0x403, 0x400,
        0x3fd, 0x3fa, 0x3f7, 0x3f5, 0x3f2, 0x3ef, 0x3ed, 0x3ea, 0x3e7, 0x3e4, 0x3e2, 0x3df, 0x3dc, 0x3da, 0x3d7, 0x3d4,
        0x3d2, 0x3cf, 0x3cc, 0x3ca, 0x3c7, 0x3c5, 0x3c2, 0x3bf, 0x3bd, 0x3ba, 0x3b8, 0x3b5, 0x3b2, 0x3b0, 0x3ad, 0x3ab,
        0x3a8, 0x3a6, 0x3a3, 0x3a1, 0x39e, 0x39c, 0x399, 0x397, 0x394, 0x392, 0x38f, 0x38d, 0x38a, 0x388, 0x385, 0x383,
        0x381, 0x37e, 0x37c, 0x379, 0x377, 0x374, 0x372, 0x370, 0x36d, 0x36b, 0x369, 0x366, 0x364, 0x362, 0x35f, 0x35d,
        0x35a, 0x358, 0x356, 0x354, 0x351, 0x34f, 0x34d, 0x34a, 0x348, 0x346, 0x344, 0x341, 0x33f, 0x33d, 0x33b, 0x338,
        0x336, 0x334, 0x332, 0x32f, 0x32d, 0x32b, 0x329, 0x327, 0x324, 0x322, 0x320, 0x31e, 0x31c, 0x31a, 0x318, 0x315,
        0x313, 0x311, 0x30f, 0x30d, 0x30b, 0x309, 0x307, 0x304, 0x302, 0x300, 0x2fe, 0x2fc, 0x2fa, 0x2f8, 0x2f6, 0x2f4,
        0x2f2, 0x2f0, 0x2ee, 0x2ec, 0x2ea, 0x2e8, 0x2e6, 0x2e4, 0x2e2, 0x2e0, 0x2de, 0x2dc, 0x2da, 0x2d8, 0x2d6, 0x2d4,
        0x2d2, 0x2d0, 0x2ce, 0x2cc, 0x2ca, 0x2c8, 0x2c6, 0x2c4, 0x2c2, 0x2c0, 0x2bf, 0x2bd, 0x2bb, 0x2b9, 0x2b7, 0x2b5,
        0x2b3, 0x2b1, 0x2b0, 0x2ae, 0x2ac, 0x2aa, 0x2a8, 0x2a6, 0x2a4, 0x2a3, 0x2a1, 0x29f, 0x29d, 0x29b, 0x29a, 0x298,
        0x296, 0x294, 0x292, 0x291, 0x28f, 0x28d, 0x28b, 0x28a, 0x288, 0x286, 0x284, 0x283, 0x281, 0x27f, 0x27d, 0x27c,
        0x27a, 0x278, 0x276, 0x275, 0x273, 0x271, 0x270, 0x26e, 0x26c, 0x26b, 0x269, 0x267, 0x266, 0x264, 0x262, 0x261,
        0x25f, 0x25d, 0x25c, 0x25a, 0x258, 0x257, 0x255, 0x254, 0x252, 0x250, 0x24f, 0x24d, 0x24c, 0x24a, 0x248, 0x247,
        0x245, 0x244, 0x242, 0x241, 0x23f, 0x23d, 0x23c, 0x23a, 0x239, 0x237, 0x236, 0x234, 0x233, 0x231, 0x230, 0x22e,
        0x22d, 0x22b, 0x22a, 0x228, 0x227, 0x225, 0x224, 0x222, 0x221, 0x21f, 0x21e, 0x21c, 0x21b, 0x219, 0x218, 0x216,
        0x215, 0x214, 0x212, 0x211, 0x20f, 0x20e, 0x20c, 0x20b, 0x20a, 0x208, 0x207, 0x205, 0x204, 0x203, 0x201, 0x200,
        0x1fe, 0x1fd, 0x1fb, 0x1fa, 0x1f9, 0x1f7, 0x1f6, 0x1f5, 0x1f3, 0x1f2, 0x1f1, 0x1ef, 0x1ee, 0x1ed, 0x1eb, 0x1ea,
        0x1e9, 0x1e7, 0x1e6, 0x1e5, 0x1e3, 0x1e2, 0x1e1, 0x1df, 0x1de, 0x1dd, 0x1dc, 0x1da, 0x1d9, 0x1d8, 0x1d6, 0x1d5,
        0x1d4, 0x1d3, 0x1d1, 0x1d0, 0x1cf, 0x1ce, 0x1cc, 0x1cb, 0x1ca, 0x1c9, 0x1c7, 0x1c6, 0x1c5, 0x1c4, 0x1c2, 0x1c1,
        0x1c0, 0x1bf, 0x1be, 0x1bc, 0x1bb, 0x1ba, 0x1b9, 0x1b8, 0x1b6, 0x1b5, 0x1b4, 0x1b3, 0x1b2, 0x1b1, 0x1af, 0x1ae,
        0x1ad, 0x1ac, 0x1ab, 0x1aa, 0x1a8, 0x1a7, 0x1a6, 0x1a5, 0x1a4, 0x1a3, 0x1a2, 0x1a0, 0x19f, 0x19e, 0x19d, 0x19c,
        0x19b, 0x19a, 0x199, 0x197, 0x196, 0x195, 0x194, 0x193, 0x192, 0x191, 0x190, 0x18f, 0x18e, 0x18d, 0x18c, 0x18a,
        0x189, 0x188, 0x187, 0x186, 0x185, 0x184, 0x183, 0x182, 0x181, 0x180, 0x17f, 0x17e, 0x17d, 0x17c, 0x17b, 0x17a,
        0x179, 0x178, 0x177, 0x176, 0x175, 0x174, 0x173, 0x172, 0x171, 0x170, 0x16f, 0x16e, 0x16d, 0x16c, 0x16b, 0x16a,
        0x169, 0x168, 0x167, 0x166, 0x165, 0x164, 0x163, 0x162, 0x161, 0x160, 0x15f, 0x15e, 0x15d, 0x15c, 0x15b, 0x15a,
        0x159, 0x158, 0x158, 0x157, 0x156, 0x155, 0x154, 0x153, 0x152, 0x151, 0x150, 0x14f, 0x14e, 0x14d, 0x14d, 0x14c,
        0x14b, 0x14a, 0x149, 0x148, 0x147, 0x146, 0x145, 0x145, 0x144, 0x143, 0x142, 0x141, 0x140, 0x13f, 0x13e, 0x13e,
        0x13d, 0x13c, 0x13b, 0x13a, 0x139, 0x138, 0x138, 0x137, 0x136, 0x135, 0x134, 0x133, 0x133, 0x132, 0x131, 0x130,
        0x12f, 0x12e, 0x12e, 0x12d, 0x12c, 0x12b, 0x12a, 0x12a, 0x129, 0x128, 0x127, 0x126, 0x126, 0x125, 0x124, 0x123,
        0x122, 0x122, 0x121, 0x120, 0x11f, 0x11e, 0x11e, 0x11d, 0x11c, 0x11b, 0x11b, 0x11a, 0x119, 0x118, 0x118, 0x117,
        0x116, 0x115, 0x115, 0x114, 0x113, 0x112, 0x112, 0x111, 0x110, 0x10f, 0x10f, 0x10e, 0x10d, 0x10c, 0x10c, 0x10b,
        0x10a, 0x10a, 0x109, 0x108, 0x107, 0x107, 0x106, 0x105, 0x105, 0x104, 0x103, 0x102, 0x102, 0x101, 0x100, 0x100,
        0x0ff, 0x0fe, 0x0fd, 0x0fd, 0x0fc, 0x0fb, 0x0fb, 0x0fa, 0x0f9, 0x0f9, 0x0f8, 0x0f7, 0x0f7, 0x0f6, 0x0f5, 0x0f5,
        0x0f4, 0x0f3, 0x0f3, 0x0f2, 0x0f1, 0x0f1, 0x0f0, 0x0ef, 0x0ef, 0x0ee, 0x0ee, 0x0ed, 0x0ec, 0x0ec, 0x0eb, 0x0ea,
        0x0ea, 0x0e9, 0x0e8, 0x0e8, 0x0e7, 0x0e7, 0x0e6, 0x0e5, 0x0e5, 0x0e4, 0x0e3, 0x0e3, 0x0e2, 0x0e2, 0x0e1, 0x0e0,
        0x0e0, 0x0df, 0x0df, 0x0de, 0x0dd, 0x0dd, 0x0dc, 0x0dc, 0x0db, 0x0da, 0x0da, 0x0d9, 0x0d9, 0x0d8, 0x0d7, 0x0d7,
        0x0d6, 0x0d6, 0x0d5, 0x0d5, 0x0d4, 0x0d3, 0x0d3, 0x0d2, 0x0d2, 0x0d1, 0x0d1, 0x0d0, 0x0cf, 0x0cf, 0x0ce, 0x0ce,
        0x0cd, 0x0cd, 0x0cc, 0x0cb, 0x0cb, 0x0ca, 0x0ca, 0x0c9, 0x0c9, 0x0c8, 0x0c8, 0x0c7, 0x0c7, 0x0c6, 0x0c6, 0x0c5,
        0x0c4, 0x0c4, 0x0c3, 0x0c3, 0x0c2, 0x0c2, 0x0c1, 0x0c1, 0x0c0, 0x0c0, 0x0bf, 0x0bf, 0x0be, 0x0be, 0x0bd, 0x0bd,
        0x0bc, 0x0bc, 0x0bb, 0x0bb, 0x0ba, 0x0ba, 0x0b9, 0x0b9, 0x0b8, 0x0b8, 0x0b7, 0x0b7, 0x0b6, 0x0b6, 0x0b5, 0x0b5,
        0x0b4, 0x0b4, 0x0b3, 0x0b3, 0x0b2, 0x0b2, 0x0b1, 0x0b1, 0x0b0, 0x0b0, 0x0af, 0x0af, 0x0ae, 0x0ae, 0x0ad, 0x0ad,
        0x0ac, 0x0ac, 0x0ac, 0x0ab, 0x0ab, 0x0aa, 0x0aa, 0x0a9, 0x0a9, 0x0a8, 0x0a8, 0x0a7, 0x0a7, 0x0a6, 0x0a6, 0x0a6,
        0x0a5, 0x0a5, 0x0a4, 0x0a4, 0x0a3, 0x0a3, 0x0a2, 0x0a2, 0x0a2, 0x0a1, 0x0a1, 0x0a0, 0x0a0, 0x09f, 0x09f, 0x09f,
        0x09e, 0x09e, 0x09d, 0x09d, 0x09c, 0x09c, 0x09c, 0x09b, 0x09b, 0x09a, 0x09a, 0x099, 0x099, 0x099, 0x098, 0x098,
        0x097, 0x097, 0x097, 0x096, 0x096, 0x095, 0x095, 0x095, 0x094, 0x094, 0x093, 0x093, 0x093, 0x092, 0x092, 0x091,
        0x091, 0x091, 0x090, 0x090, 0x08f, 0x08f, 0x08f, 0x08e, 0x08e, 0x08d, 0x08d, 0x08d, 0x08c, 0x08c, 0x08c, 0x08b,
        0x08b, 0x08a, 0x08a, 0x08a, 0x089, 0x089, 0x089, 0x088, 0x088, 0x087, 0x087, 0x087, 0x086, 0x086, 0x086, 0x085,
        0x085, 0x085, 0x084, 0x084, 0x083, 0x083, 0x083, 0x082, 0x082, 0x082, 0x081, 0x081, 0x081, 0x080, 0x080, 0x080,
        0x07f, 0x07f, 0x07e, 0x07e, 0x07e, 0x07d, 0x07d, 0x07d, 0x07c, 0x07c, 0x07c, 0x07b, 0x07b, 0x07b, 0x07a, 0x07a,
        0x07a, 0x079, 0x079, 0x079, 0x078, 0x078, 0x078, 0x077, 0x077, 0x077, 0x077, 0x076, 0x076, 0x076, 0x075, 0x075,
        0x075, 0x074, 0x074, 0x074, 0x073, 0x073, 0x073, 0x072, 0x072, 0x072, 0x071, 0x071, 0x071, 0x071, 0x070, 0x070,
        0x070, 0x06f, 0x06f, 0x06f, 0x06e, 0x06e, 0x06e, 0x06e, 0x06d, 0x06d, 0x06d, 0x06c, 0x06c, 0x06c, 0x06b, 0x06b,
        0x06b, 0x06b, 0x06a, 0x06a, 0x06a, 0x069, 0x069, 0x069, 0x069, 0x068, 0x068, 0x068, 0x067, 0x067, 0x067, 0x067,
        0x066, 0x066, 0x066, 0x065, 0x065, 0x065, 0x065, 0x064, 0x064, 0x064, 0x064, 0x063, 0x063, 0x063, 0x063, 0x062,
        0x062, 0x062, 0x061, 0x061, 0x061, 0x061, 0x060, 0x060, 0x060, 0x060, 0x05f, 0x05f, 0x05f, 0x05f, 0x05e, 0x05e,
        0x05e, 0x05e, 0x05d, 0x05d, 0x05d, 0x05d, 0x05c, 0x05c, 0x05c, 0x05c, 0x05b, 0x05b, 0x05b, 0x05b, 0x05a, 0x05a,
        0x05a, 0x05a, 0x059, 0x059, 0x059, 0x059, 0x058, 0x058, 0x058, 0x058, 0x057, 0x057, 0x057, 0x057, 0x056, 0x056,
        0x056, 0x056, 0x056, 0x055, 0x055, 0x055, 0x055, 0x054, 0x054, 0x054, 0x054, 0x053, 0x053, 0x053, 0x053, 0x053,
        0x052, 0x052, 0x052, 0x052, 0x051, 0x051, 0x051, 0x051, 0x051, 0x050, 0x050, 0x050, 0x050, 0x04f, 0x04f, 0x04f,
        0x04f, 0x04f, 0x04e, 0x04e, 0x04e, 0x04e, 0x04e, 0x04d, 0x04d, 0x04d, 0x04d, 0x04c, 0x04c, 0x04c, 0x04c, 0x04c,
        0x04b, 0x04b, 0x04b, 0x04b, 0x04b, 0x04a, 0x04a, 0x04a, 0x04a, 0x04a, 0x049, 0x049, 0x049, 0x049, 0x049, 0x048,
        0x048, 0x048, 0x048, 0x048, 0x047, 0x047, 0x047, 0x047, 0x047, 0x046, 0x046, 0x046, 0x046, 0x046, 0x046, 0x045,
        0x045, 0x045, 0x045, 0x045, 0x044, 0x044, 0x044, 0x044, 0x044, 0x043, 0x043, 0x043, 0x043, 0x043, 0x043, 0x042,
        0x042, 0x042, 0x042, 0x042, 0x041, 0x041, 0x041, 0x041, 0x041, 0x041, 0x040, 0x040, 0x040, 0x040, 0x040, 0x040,
        0x03f, 0x03f, 0x03f, 0x03f, 0x03f, 0x03e, 0x03e, 0x03e, 0x03e, 0x03e, 0x03e, 0x03d, 0x03d, 0x03d, 0x03d, 0x03d,
        0x03d, 0x03c, 0x03c, 0x03c, 0x03c, 0x03c, 0x03c, 0x03b, 0x03b, 0x03b, 0x03b, 0x03b, 0x03b, 0x03b, 0x03a, 0x03a,
        0x03a, 0x03a, 0x03a, 0x03a, 0x039, 0x039, 0x039, 0x039, 0x039, 0x039, 0x038, 0x038, 0x038, 0x038, 0x038, 0x038,
        0x038, 0x037, 0x037, 0x037, 0x037, 0x037, 0x037, 0x037, 0x036, 0x036, 0x036, 0x036, 0x036, 0x036, 0x035, 0x035,
        0x035, 0x035, 0x035, 0x035, 0x035, 0x034, 0x034, 0x034, 0x034, 0x034, 0x034, 0x034, 0x033, 0x033, 0x033, 0x033,
        0x033, 0x033, 0x033, 0x032, 0x032, 0x032, 0x032, 0x032, 0x032, 0x032, 0x032, 0x031, 0x031, 0x031, 0x031, 0x031,
        0x031, 0x031, 0x030, 0x030, 0x030, 0x030, 0x030, 0x030, 0x030, 0x030, 0x02f, 0x02f, 0x02f, 0x02f, 0x02f, 0x02f,
        0x02f, 0x02f, 0x02e, 0x02e, 0x02e, 0x02e, 0x02e, 0x02e, 0x02e, 0x02e, 0x02d, 0x02d, 0x02d, 0x02d, 0x02d, 0x02d,
        0x02d, 0x02d, 0x02c, 0x02c, 0x02c, 0x02c, 0x02c, 0x02c, 0x02c, 0x02c, 0x02b, 0x02b, 0x02b, 0x02b, 0x02b, 0x02b,
        0x02b, 0x02b, 0x02b, 0x02a, 0x02a, 0x02a, 0x02a, 0x02a, 0x02a, 0x02a, 0x02a, 0x029, 0x029, 0x029, 0x029, 0x029,
        0x029, 0x029, 0x029, 0x029, 0x028, 0x028, 0x028, 0x028, 0x028, 0x028, 0x028, 0x028, 0x028, 0x027, 0x027, 0x027,
        0x027, 0x027, 0x027, 0x027, 0x027, 0x027, 0x027, 0x026, 0x026, 0x026, 0x026, 0x026, 0x026, 0x026, 0x026, 0x026,
        0x025, 0x025, 0x025, 0x025, 0x025, 0x025, 0x025, 0x025, 0x025, 0x025, 0x024, 0x024, 0x024, 0x024, 0x024, 0x024,
        0x024, 0x024, 0x024, 0x024, 0x023, 0x023, 0x023, 0x023, 0x023, 0x023, 0x023, 0x023, 0x023, 0x023, 0x023, 0x022,
        0x022, 0x022, 0x022, 0x022, 0x022, 0x022, 0x022, 0x022, 0x022, 0x021, 0x021, 0x021, 0x021, 0x021, 0x021, 0x021,
        0x021, 0x021, 0x021, 0x021, 0x020, 0x020, 0x020, 0x020, 0x020, 0x020, 0x020, 0x020, 0x020, 0x020, 0x020, 0x020,
        0x01f, 0x01f, 0x01f, 0x01f, 0x01f, 0x01f, 0x01f, 0x01f, 0x01f, 0x01f, 0x01f, 0x01e, 0x01e, 0x01e, 0x01e, 0x01e,
        0x01e, 0x01e, 0x01e, 0x01e, 0x01e, 0x01e, 0x01e, 0x01d, 0x01d, 0x01d, 0x01d, 0x01d, 0x01d, 0x01d, 0x01d, 0x01d,
        0x01d, 0x01d, 0x01d, 0x01d, 0x01c, 0x01c, 0x01c, 0x01c, 0x01c, 0x01c, 0x01c, 0x01c, 0x01c, 0x01c, 0x01c, 0x01c,
        0x01c, 0x01b, 0x01b, 0x01b, 0x01b, 0x01b, 0x01b, 0x01b, 0x01b, 0x01b, 0x01b, 0x01b, 0x01b, 0x01b, 0x01a, 0x01a,
        0x01a, 0x01a, 0x01a, 0x01a, 0x01a, 0x01a, 0x01a, 0x01a, 0x01a, 0x01a, 0x01a, 0x01a, 0x019, 0x019, 0x019, 0x019,
        0x019, 0x019, 0x019, 0x019, 0x019, 0x019, 0x019, 0x019, 0x019, 0x019, 0x019, 0x018, 0x018, 0x018, 0x018, 0x018,
        0x018, 0x018, 0x018, 0x018, 0x018, 0x018, 0x018, 0x018, 0x018, 0x018, 0x017, 0x017, 0x017, 0x017, 0x017, 0x017,
        0x017, 0x017, 0x017, 0x017, 0x017, 0x017, 0x017, 0x017, 0x017, 0x017, 0x016, 0x016, 0x016, 0x016, 0x016, 0x016,
        0x016, 0x016, 0x016, 0x016, 0x016, 0x016, 0x016, 0x016, 0x016, 0x016, 0x015, 0x015, 0x015, 0x015, 0x015, 0x015,
        0x015, 0x015, 0x015, 0x015, 0x015, 0x015, 0x015, 0x015, 0x015, 0x015, 0x015, 0x014, 0x014, 0x014, 0x014, 0x014,
        0x014, 0x014, 0x014, 0x014, 0x014, 0x014, 0x014, 0x014, 0x014, 0x014, 0x014, 0x014, 0x014, 0x013, 0x013, 0x013,
        0x013, 0x013, 0x013, 0x013, 0x013, 0x013, 0x013, 0x013, 0x013, 0x013, 0x013, 0x013, 0x013, 0x013, 0x013, 0x013,
        0x012, 0x012, 0x012, 0x012, 0x012, 0x012, 0x012, 0x012, 0x012, 0x012, 0x012, 0x012, 0x012, 0x012, 0x012, 0x012,
        0x012, 0x012, 0x012, 0x012, 0x011, 0x011, 0x011, 0x011, 0x011, 0x011, 0x011, 0x011, 0x011, 0x011, 0x011, 0x011,
        0x011, 0x011, 0x011, 0x011, 0x011, 0x011, 0x011, 0x011, 0x011, 0x010, 0x010, 0x010, 0x010, 0x010, 0x010, 0x010,
        0x010, 0x010, 0x010, 0x010, 0x010, 0x010, 0x010, 0x010, 0x010, 0x010, 0x010, 0x010, 0x010, 0x010, 0x010, 0x010,
        0x00f, 0x00f, 0x00f, 0x00f, 0x00f, 0x00f, 0x00f, 0x00f, 0x00f, 0x00f, 0x00f, 0x00f, 0x00f, 0x00f, 0x00f, 0x00f,
        0x00f, 0x00f, 0x00f, 0x00f, 0x00f, 0x00f, 0x00f, 0x00e, 0x00e, 0x00e, 0x00e, 0x00e, 0x00e, 0x00e, 0x00e, 0x00e,
        0x00e, 0x00e, 0x00e, 0x00e, 0x00e, 0x00e, 0x00e, 0x00e, 0x00e, 0x00e, 0x00e, 0x00e, 0x00e, 0x00e, 0x00e, 0x00e,
        0x00e, 0x00d, 0x00d, 0x00d, 0x00d, 0x00d, 0x00d, 0x00d, 0x00d, 0x00d, 0x00d, 0x00d, 0x00d, 0x00d, 0x00d, 0x00d,
        0x00d, 0x00d, 0x00d, 0x00d, 0x00d, 0x00d, 0x00d, 0x00d, 0x00d, 0x00d, 0x00d, 0x00d, 0x00c, 0x00c, 0x00c, 0x00c,
        0x00c, 0x00c, 0x00c, 0x00c, 0x00c, 0x00c, 0x00c, 0x00c, 0x00c, 0x00c, 0x00c, 0x00c, 0x00c, 0x00c, 0x00c, 0x00c,
        0x00c, 0x00c, 0x00c, 0x00c, 0x00c, 0x00c, 0x00c, 0x00c, 0x00c, 0x00c, 0x00b, 0x00b, 0x00b, 0x00b, 0x00b, 0x00b,
        0x00b, 0x00b, 0x00b, 0x00b, 0x00b, 0x00b, 0x00b, 0x00b, 0x00b, 0x00b, 0x00b, 0x00b, 0x00b, 0x00b, 0x00b, 0x00b,
        0x00b, 0x00b, 0x00b, 0x00b, 0x00b, 0x00b, 0x00b, 0x00b, 0x00b, 0x00b, 0x00a, 0x00a, 0x00a, 0x00a, 0x00a, 0x00a,
        0x00a, 0x00a, 0x00a, 0x00a, 0x00a, 0x00a, 0x00a, 0x00a, 0x00a, 0x00a, 0x00a, 0x00a, 0x00a, 0x00a, 0x00a, 0x00a,
        0x00a, 0x00a, 0x00a, 0x00a, 0x00a, 0x00a, 0x00a, 0x00a, 0x00a, 0x00a, 0x00a, 0x00a, 0x00a, 0x009, 0x009, 0x009,
        0x009, 0x009, 0x009, 0x009, 0x009, 0x009, 0x009, 0x009, 0x009, 0x009, 0x009, 0x009, 0x009, 0x009, 0x009, 0x009,
        0x009, 0x009, 0x009, 0x009, 0x009, 0x009, 0x009, 0x009, 0x009, 0x009, 0x009, 0x009, 0x009, 0x009, 0x009, 0x009,
        0x009, 0x009, 0x009, 0x009, 0x008, 0x008, 0x008, 0x008, 0x008, 0x008, 0x008, 0x008, 0x008, 0x008, 0x008, 0x008,
        0x008, 0x008, 0x008, 0x008, 0x008, 0x008, 0x008, 0x008, 0x008, 0x008, 0x008, 0x008, 0x008, 0x008, 0x008, 0x008,
        0x008, 0x008, 0x008, 0x008, 0x008, 0x008, 0x008, 0x008, 0x008, 0x008, 0x008, 0x008, 0x008, 0x008, 0x008, 0x008,
        0x007, 0x007, 0x007, 0x007, 0x007, 0x007, 0x007, 0x007, 0x007, 0x007, 0x007, 0x007, 0x007, 0x007, 0x007, 0x007,
        0x007, 0x007, 0x007, 0x007, 0x007, 0x007, 0x007, 0x007, 0x007, 0x007, 0x007, 0x007, 0x007, 0x007, 0x007, 0x007,
        0x007, 0x007, 0x007, 0x007, 0x007, 0x007, 0x007, 0x007, 0x007, 0x007, 0x007, 0x007, 0x007, 0x007, 0x007, 0x007,
        0x007, 0x006, 0x006, 0x006, 0x006, 0x006, 0x006, 0x006, 0x006, 0x006, 0x006, 0x006, 0x006, 0x006, 0x006, 0x006,
        0x006, 0x006, 0x006, 0x006, 0x006, 0x006, 0x006, 0x006, 0x006, 0x006, 0x006, 0x006, 0x006, 0x006, 0x006, 0x006,
        0x006, 0x006, 0x006, 0x006, 0x006, 0x006, 0x006, 0x006, 0x006, 0x006, 0x006, 0x006, 0x006, 0x006, 0x006, 0x006,
        0x006, 0x006, 0x006, 0x006, 0x006, 0x006, 0x006, 0x006, 0x006, 0x006, 0x005, 0x005, 0x005, 0x005, 0x005, 0x005,
        0x005, 0x005, 0x005, 0x005, 0x005, 0x005, 0x005, 0x005, 0x005, 0x005, 0x005, 0x005, 0x005, 0x005, 0x005, 0x005,
        0x005, 0x005, 0x005, 0x005, 0x005, 0x005, 0x005, 0x005, 0x005, 0x005, 0x005, 0x005, 0x005, 0x005, 0x005, 0x005,
        0x005, 0x005, 0x005, 0x005, 0x005, 0x005, 0x005, 0x005, 0x005, 0x005, 0x005, 0x005, 0x005, 0x005, 0x005, 0x005,
        0x005, 0x005, 0x005, 0x005, 0x005, 0x005, 0x005, 0x005, 0x005, 0x005, 0x005, 0x005, 0x005, 0x004, 0x004, 0x004,
        0x004, 0x004, 0x004, 0x004, 0x004, 0x004, 0x004, 0x004, 0x004, 0x004, 0x004, 0x004, 0x004, 0x004, 0x004, 0x004,
        0x004, 0x004, 0x004, 0x004, 0x004, 0x004, 0x004, 0x004, 0x004, 0x004, 0x004, 0x004, 0x004, 0x004, 0x004, 0x004,
        0x004, 0x004, 0x004, 0x004, 0x004, 0x004, 0x004, 0x004, 0x004, 0x004, 0x004, 0x004, 0x004, 0x004, 0x004, 0x004,
        0x004, 0x004, 0x004, 0x004, 0x004, 0x004, 0x004, 0x004, 0x004, 0x004, 0x004, 0x004, 0x004, 0x004, 0x004, 0x004,
        0x004, 0x004, 0x004, 0x004, 0x004, 0x004, 0x004, 0x004, 0x004, 0x004, 0x004, 0x004, 0x004, 0x004, 0x004, 0x004,
        0x003, 0x003, 0x003, 0x003, 0x003, 0x003, 0x003, 0x003, 0x003, 0x003, 0x003, 0x003, 0x003, 0x003, 0x003, 0x003,
        0x003, 0x003, 0x003, 0x003, 0x003, 0x003, 0x003, 0x003, 0x003, 0x003, 0x003, 0x003, 0x003, 0x003, 0x003, 0x003,
        0x003, 0x003, 0x003, 0x003, 0x003, 0x003, 0x003, 0x003, 0x003, 0x003, 0x003, 0x003, 0x003, 0x003, 0x003, 0x003,
        0x003, 0x003, 0x003, 0x003, 0x003, 0x003, 0x003, 0x003, 0x003, 0x003, 0x003, 0x003, 0x003, 0x003, 0x003, 0x003,
        0x003, 0x003, 0x003, 0x003, 0x003, 0x003, 0x003, 0x003, 0x003, 0x003, 0x003, 0x003, 0x003, 0x003, 0x003, 0x003,
        0x003, 0x003, 0x003, 0x003, 0x003, 0x003, 0x003, 0x003, 0x003, 0x003, 0x003, 0x003, 0x003, 0x003, 0x003, 0x003,
        0x003, 0x003, 0x003, 0x003, 0x003, 0x003, 0x003, 0x003, 0x003, 0x003, 0x002, 0x002, 0x002, 0x002, 0x002, 0x002,
        0x002, 0x002, 0x002, 0x002, 0x002, 0x002, 0x002, 0x002, 0x002, 0x002, 0x002, 0x002, 0x002, 0x002, 0x002, 0x002,
        0x002, 0x002, 0x002, 0x002, 0x002, 0x002, 0x002, 0x002, 0x002, 0x002, 0x002, 0x002, 0x002, 0x002, 0x002, 0x002,
        0x002, 0x002, 0x002, 0x002, 0x002, 0x002, 0x002, 0x002, 0x002, 0x002, 0x002, 0x002, 0x002, 0x002, 0x002, 0x002,
        0x002, 0x002, 0x002, 0x002, 0x002, 0x002, 0x002, 0x002, 0x002, 0x002, 0x002, 0x002, 0x002, 0x002, 0x002, 0x002,
        0x002, 0x002, 0x002, 0x002, 0x002, 0x002, 0x002, 0x002, 0x002, 0x002, 0x002, 0x002, 0x002, 0x002, 0x002, 0x002,
        0x002, 0x002, 0x002, 0x002, 0x002, 0x002, 0x002, 0x002, 0x002, 0x002, 0x002, 0x002, 0x002, 0x002, 0x002, 0x002,
        0x002, 0x002, 0x002, 0x002, 0x002, 0x002, 0x002, 0x002, 0x002, 0x002, 0x002, 0x002, 0x002, 0x002, 0x002, 0x002,
        0x002, 0x002, 0x002, 0x002, 0x002, 0x002, 0x002, 0x002, 0x002, 0x002, 0x002, 0x002, 0x002, 0x002, 0x002, 0x002,
        0x002, 0x002, 0x002, 0x002, 0x002, 0x002, 0x002, 0x002, 0x002, 0x002, 0x002, 0x002, 0x002, 0x002, 0x002, 0x002,
        0x001, 0x001, 0x001, 0x001, 0x001, 0x001, 0x001, 0x001, 0x001, 0x001, 0x001, 0x001, 0x001, 0x001, 0x001, 0x001,
        0x001, 0x001, 0x001, 0x001, 0x001, 0x001, 0x001, 0x001, 0x001, 0x001, 0x001, 0x001, 0x001, 0x001, 0x001, 0x001,
        0x001, 0x001, 0x001, 0x001, 0x001, 0x001, 0x001, 0x001, 0x001, 0x001, 0x001, 0x001, 0x001, 0x001, 0x001, 0x001,
        0x001, 0x001, 0x001, 0x001, 0x001, 0x001, 0x001, 0x001, 0x001, 0x001, 0x001, 0x001, 0x001, 0x001, 0x001, 0x001,
        0x001, 0x001, 0x001, 0x001, 0x001, 0x001, 0x001, 0x001, 0x001, 0x001, 0x001, 0x001, 0x001, 0x001, 0x001, 0x001,
        0x001, 0x001, 0x001, 0x001, 0x001, 0x001, 0x001, 0x001, 0x001, 0x001, 0x001, 0x001, 0x001, 0x001, 0x001, 0x001,
        0x001, 0x001, 0x001, 0x001, 0x001, 0x001, 0x001, 0x001, 0x001, 0x001, 0x001, 0x001, 0x001, 0x001, 0x001, 0x001,
        0x001, 0x001, 0x001, 0x001, 0x001, 0x001, 0x001, 0x001, 0x001, 0x001, 0x001, 0x001, 0x001, 0x001, 0x001, 0x001,
        0x001, 0x001, 0x001, 0x001, 0x001, 0x001, 0x001, 0x001, 0x001, 0x001, 0x001, 0x001, 0x001, 0x001, 0x001, 0x001,
        0x001, 0x001, 0x001, 0x001, 0x001, 0x001, 0x001, 0x001, 0x001, 0x001, 0x001, 0x001, 0x001, 0x001, 0x001, 0x001,
        0x001, 0x001, 0x001, 0x001, 0x001, 0x001, 0x001, 0x001, 0x001, 0x001, 0x001, 0x001, 0x001, 0x001, 0x001, 0x001,
        0x001, 0x001, 0x001, 0x001, 0x001, 0x001, 0x001, 0x001, 0x001, 0x001, 0x001, 0x001, 0x001, 0x001, 0x001, 0x001,
        0x001, 0x001, 0x001, 0x001, 0x001, 0x001, 0x001, 0x001, 0x001, 0x001, 0x001, 0x001, 0x001, 0x001, 0x001, 0x001,
        0x001, 0x001, 0x001, 0x001, 0x001, 0x001, 0x001, 0x001, 0x001, 0x001, 0x001, 0x001, 0x001, 0x001, 0x001, 0x001,
        0x001, 0x001, 0x001, 0x001, 0x001, 0x001, 0x001, 0x001, 0x001, 0x001, 0x001, 0x001, 0x001, 0x001, 0x001, 0x001,
        0x001, 0x001, 0x001, 0x001, 0x001, 0x001, 0x001, 0x001, 0x001, 0x001, 0x001, 0x001, 0x001, 0x001, 0x001, 0x001,
        // after here, all 0: no need to be in the table.
        /*
        0x000, 0x000, 0x000, 0x000, 0x000, 0x000, 0x000, 0x000, 0x000, 0x000, 0x000, 0x000, 0x000, 0x000, 0x000, 0x000,
        0x000, 0x000, 0x000, 0x000, 0x000, 0x000, 0x000, 0x000, 0x000, 0x000, 0x000, 0x000, 0x000, 0x000, 0x000, 0x000,
        0x000, 0x000, 0x000, 0x000, 0x000, 0x000, 0x000, 0x000, 0x000, 0x000, 0x000, 0x000, 0x000, 0x000, 0x000, 0x000,
        0x000, 0x000, 0x000, 0x000, 0x000, 0x000, 0x000, 0x000, 0x000, 0x000, 0x000, 0x000, 0x000, 0x000, 0x000, 0x000,*/
};
#endif
#if (RENDER_SAMPLE_RATE == 49716)
#warning these values are valid only when fsample = 49716 Hz
static const float attack_const [16][4] =
{
    { 1,  1 ,  1 ,  1 },
    { 0.999955617 ,  0.99994432  ,  0.999933426 ,  0.999921478 },
    { 0.999911236 ,  0.999888643 ,  0.999866857 ,  0.999842961 },
    { 0.99982248  ,  0.999777298 ,  0.999733731 ,  0.999685947 },
    { 0.999644991 ,  0.999554645 ,  0.999467534 ,  0.999371993 },
    { 0.999290108 ,  0.999109488 ,  0.998935351 ,  0.99874438  },
    { 0.99858072  ,  0.99821977  ,  0.997871835 ,  0.997490336 },
    { 0.997163453 ,  0.996442709 ,  0.995748199 ,  0.994986971 },
    { 0.994334953 ,  0.992898072 ,  0.991514475 ,  0.989999072 },
    { 0.988701998 ,  0.985846582 ,  0.983100955 ,  0.980098162 },
    { 0.977531642 ,  0.971893483 ,  0.966487487 ,  0.960592408 },
    { 0.95556811  ,  0.944576942 ,  0.934098063 ,  0.922737775 },
    { 0.913110413 ,  0.8922256 ,  0.872539192 ,  0.851445  },
    { 0.833770627 ,  0.796066521 ,  0.761324641 ,  0.724958589 },
    { 0.695173458 ,  0.633721905 ,  0.579615209 ,  0.525564956 },
    { 0 ,  0 ,  0 ,  0 },
};
static const float decay_release_const[16][4] =
{
    {0, 0, 0, 0},
    {0.000262178,    0.000327807,    0.000393471,    0.00045881},
    {0.000524356,    0.000655614,    0.000786942,    0.000917621},
    {0.001048712,    0.001311229,    0.001573885,    0.001835242},
    {0.002097424,    0.002622457,    0.00314777,    0.003670483},
    {0.004194849,    0.005244915,    0.00629554,    0.007340967},
    {0.008389698,    0.01048983,    0.012591079,    0.014681934},
    {0.016779395,    0.02097966,    0.025182158,    0.029363867},
    {0.033558791,    0.04195932,    0.050364317,    0.058727734},
    {0.067117581,    0.08391864,    0.100728633,    0.117455468},
    {0.134235163,    0.167837279,    0.201457266,    0.234910936},
    {0.268470325,    0.335674558,    0.402914533,    0.469821873},
    {0.53694065,    0.671349117,    0.805829065,    0.939643746},
    {1.073881301,    1.342698234,    1.611658131,    1.879287492},
    {2.147762601,    2.685396468,    3.223316261,    3.758574983},
    {4.295525202,    4.295525202,    4.295525202,    4.295525202}
};

const uint32_t attackDurationTable[4][512] =
{
        {
                1, 2, 3464, 5490, 6927, 8042, 8953, 9723,
                10390, 10978, 11505, 11981, 12415, 12815, 13185, 13530,
                13852, 14155, 14441, 14711, 14967, 15211, 15443, 15665,
                15878, 16082, 16278, 16466, 16648, 16823, 16993, 17157,
                17315, 17469, 17618, 17763, 17904, 18041, 18174, 18304,
                18430, 18553, 18674, 18791, 18906, 19018, 19128, 19236,
                19341, 19444, 19545, 19644, 19741, 19836, 19929, 20021,
                20111, 20199, 20286, 20372, 20456, 20538, 20619, 20699,
                20778, 20855, 20932, 21007, 21081, 21154, 21226, 21297,
                21366, 21435, 21503, 21570, 21636, 21702, 21766, 21830,
                21893, 21955, 22016, 22077, 22136, 22196, 22254, 22312,
                22369, 22425, 22481, 22536, 22591, 22645, 22698, 22751,
                22804, 22855, 22907, 22957, 23008, 23057, 23106, 23155,
                23203, 23251, 23299, 23346, 23392, 23438, 23484, 23529,
                23574, 23618, 23662, 23706, 23749, 23792, 23834, 23877,
                23918, 23960, 24001, 24042, 24082, 24122, 24162, 24202,
                24241, 24280, 24318, 24356, 24394, 24432, 24470, 24507,
                24544, 24580, 24617, 24653, 24688, 24724, 24759, 24794,
                24829, 24864, 24898, 24932, 24966, 25000, 25033, 25066,
                25099, 25132, 25165, 25197, 25229, 25261, 25293, 25324,
                25355, 25387, 25418, 25448, 25479, 25509, 25539, 25569,
                25599, 25629, 25658, 25688, 25717, 25746, 25775, 25803,
                25832, 25860, 25888, 25916, 25944, 25972, 25999, 26026,
                26054, 26081, 26108, 26134, 26161, 26188, 26214, 26240,
                26266, 26292, 26318, 26344, 26369, 26395, 26420, 26445,
                26470, 26495, 26520, 26545, 26569, 26594, 26618, 26642,
                26666, 26690, 26714, 26738, 26761, 26785, 26808, 26832,
                26855, 26878, 26901, 26924, 26946, 26969, 26992, 27014,
                27036, 27059, 27081, 27103, 27125, 27147, 27168, 27190,
                27212, 27233, 27255, 27276, 27297, 27318, 27339, 27360,
                27381, 27402, 27423, 27443, 27464, 27484, 27504, 27525,
                27545, 27565, 27585, 27605, 27625, 27645, 27664, 27684,
                27703, 27723, 27742, 27762, 27781, 27800, 27819, 27838,
                27857, 27876, 27895, 27914, 27932, 27951, 27969, 27988,
                28006, 28025, 28043, 28061, 28079, 28097, 28115, 28133,
                28151, 28169, 28187, 28204, 28222, 28240, 28257, 28275,
                28292, 28309, 28326, 28344, 28361, 28378, 28395, 28412,
                28429, 28446, 28462, 28479, 28496, 28512, 28529, 28546,
                28562, 28578, 28595, 28611, 28627, 28643, 28660, 28676,
                28692, 28708, 28724, 28740, 28755, 28771, 28787, 28803,
                28818, 28834, 28849, 28865, 28880, 28896, 28911, 28926,
                28942, 28957, 28972, 28987, 29002, 29017, 29032, 29047,
                29062, 29077, 29092, 29106, 29121, 29136, 29150, 29165,
                29180, 29194, 29208, 29223, 29237, 29252, 29266, 29280,
                29294, 29309, 29323, 29337, 29351, 29365, 29379, 29393,
                29407, 29421, 29434, 29448, 29462, 29476, 29489, 29503,
                29516, 29530, 29544, 29557, 29570, 29584, 29597, 29611,
                29624, 29637, 29650, 29664, 29677, 29690, 29703, 29716,
                29729, 29742, 29755, 29768, 29781, 29794, 29807, 29819,
                29832, 29845, 29857, 29870, 29883, 29895, 29908, 29920,
                29933, 29945, 29958, 29970, 29983, 29995, 30007, 30020,
                30032, 30044, 30056, 30069, 30081, 30093, 30105, 30117,
                30129, 30141, 30153, 30165, 30177, 30189, 30200, 30212,
                30224, 30236, 30248, 30259, 30271, 30283, 30294, 30306,
                30317, 30329, 30341, 30352, 30364, 30375, 30386, 30398,
                30409, 30420, 30432, 30443, 30454, 30466, 30477, 30488,
                30499, 30510, 30521, 30532, 30544, 30555, 30566, 30577,
                30588, 30599, 30609, 30620, 30631, 30642, 30653, 30664,
                30674, 30685, 30696, 30707, 30717, 30728, 30739, 30749,
                30760, 30770, 30781, 30792, 30802, 30812, 30823, 30833,
                30844, 30854, 30865, 30875, 30885, 30896, 30906, 30916,
                30926, 30937, 30947, 30957, 30967, 30977, 30987, 30998,
                31008, 31018, 31028, 31038, 31048, 31058, 31068, 31078,
                31088, 31097, 31107, 31117, 31127, 31137, 31147, 31156,
        },
        {
                1, 2, 2762, 4377, 5523, 6411, 7138, 7751,
                8283, 8752, 9172, 9552, 9898, 10217, 10512, 10787,
                11044, 11285, 11513, 11728, 11933, 12127, 12312, 12489,
                12659, 12821, 12978, 13128, 13273, 13412, 13547, 13678,
                13804, 13927, 14046, 14161, 14274, 14383, 14489, 14592,
                14693, 14792, 14887, 14981, 15073, 15162, 15250, 15335,
                15419, 15501, 15582, 15661, 15738, 15814, 15888, 15961,
                16033, 16104, 16173, 16241, 16308, 16374, 16439, 16502,
                16565, 16627, 16688, 16748, 16807, 16865, 16922, 16978,
                17034, 17089, 17143, 17197, 17249, 17302, 17353, 17404,
                17454, 17503, 17552, 17600, 17648, 17695, 17742, 17788,
                17833, 17878, 17923, 17967, 18010, 18053, 18096, 18138,
                18180, 18221, 18262, 18302, 18342, 18382, 18421, 18460,
                18499, 18537, 18575, 18612, 18649, 18686, 18722, 18758,
                18794, 18829, 18864, 18899, 18934, 18968, 19002, 19035,
                19069, 19102, 19134, 19167, 19199, 19231, 19263, 19294,
                19326, 19357, 19387, 19418, 19448, 19478, 19508, 19538,
                19567, 19596, 19625, 19654, 19683, 19711, 19739, 19767,
                19795, 19822, 19850, 19877, 19904, 19931, 19957, 19984,
                20010, 20036, 20062, 20088, 20114, 20139, 20164, 20189,
                20214, 20239, 20264, 20288, 20313, 20337, 20361, 20385,
                20409, 20432, 20456, 20479, 20502, 20525, 20548, 20571,
                20594, 20617, 20639, 20661, 20683, 20706, 20727, 20749,
                20771, 20793, 20814, 20835, 20857, 20878, 20899, 20920,
                20940, 20961, 20982, 21002, 21023, 21043, 21063, 21083,
                21103, 21123, 21143, 21162, 21182, 21201, 21221, 21240,
                21259, 21278, 21297, 21316, 21335, 21354, 21373, 21391,
                21410, 21428, 21446, 21465, 21483, 21501, 21519, 21537,
                21554, 21572, 21590, 21607, 21625, 21642, 21660, 21677,
                21694, 21711, 21728, 21745, 21762, 21779, 21796, 21813,
                21829, 21846, 21862, 21879, 21895, 21911, 21928, 21944,
                21960, 21976, 21992, 22008, 22024, 22039, 22055, 22071,
                22086, 22102, 22117, 22133, 22148, 22163, 22179, 22194,
                22209, 22224, 22239, 22254, 22269, 22284, 22298, 22313,
                22328, 22342, 22357, 22371, 22386, 22400, 22415, 22429,
                22443, 22457, 22471, 22486, 22500, 22514, 22528, 22541,
                22555, 22569, 22583, 22597, 22610, 22624, 22637, 22651,
                22664, 22678, 22691, 22705, 22718, 22731, 22744, 22758,
                22771, 22784, 22797, 22810, 22823, 22836, 22849, 22861,
                22874, 22887, 22900, 22912, 22925, 22937, 22950, 22962,
                22975, 22987, 23000, 23012, 23024, 23037, 23049, 23061,
                23073, 23085, 23098, 23110, 23122, 23134, 23145, 23157,
                23169, 23181, 23193, 23205, 23216, 23228, 23240, 23251,
                23263, 23275, 23286, 23298, 23309, 23320, 23332, 23343,
                23355, 23366, 23377, 23388, 23400, 23411, 23422, 23433,
                23444, 23455, 23466, 23477, 23488, 23499, 23510, 23521,
                23532, 23542, 23553, 23564, 23575, 23585, 23596, 23607,
                23617, 23628, 23638, 23649, 23659, 23670, 23680, 23691,
                23701, 23711, 23722, 23732, 23742, 23753, 23763, 23773,
                23783, 23793, 23803, 23814, 23824, 23834, 23844, 23854,
                23864, 23874, 23884, 23893, 23903, 23913, 23923, 23933,
                23943, 23952, 23962, 23972, 23981, 23991, 24001, 24010,
                24020, 24029, 24039, 24048, 24058, 24067, 24077, 24086,
                24096, 24105, 24114, 24124, 24133, 24142, 24152, 24161,
                24170, 24179, 24189, 24198, 24207, 24216, 24225, 24234,
                24243, 24252, 24261, 24270, 24279, 24288, 24297, 24306,
                24315, 24324, 24333, 24342, 24350, 24359, 24368, 24377,
                24386, 24394, 24403, 24412, 24420, 24429, 24438, 24446,
                24455, 24463, 24472, 24480, 24489, 24497, 24506, 24514,
                24523, 24531, 24540, 24548, 24556, 24565, 24573, 24581,
                24590, 24598, 24606, 24615, 24623, 24631, 24639, 24647,
                24656, 24664, 24672, 24680, 24688, 24696, 24704, 24712,
                24720, 24728, 24736, 24744, 24752, 24760, 24768, 24776,
                24784, 24792, 24800, 24808, 24816, 24823, 24831, 24839,
        },
        {
                1, 2, 2310, 3661, 4619, 5362, 5970, 6483,
                6928, 7320, 7671, 7989, 8279, 8545, 8792, 9022,
                9237, 9439, 9629, 9809, 9980, 10143, 10298, 10446,
                10587, 10723, 10854, 10980, 11101, 11218, 11331, 11440,
                11546, 11648, 11748, 11844, 11938, 12029, 12118, 12205,
                12289, 12371, 12452, 12530, 12606, 12681, 12755, 12826,
                12896, 12965, 13032, 13098, 13163, 13226, 13289, 13350,
                13410, 13469, 13527, 13584, 13640, 13695, 13749, 13802,
                13855, 13906, 13957, 14007, 14057, 14105, 14153, 14200,
                14247, 14293, 14338, 14383, 14427, 14471, 14514, 14556,
                14598, 14639, 14680, 14720, 14760, 14800, 14839, 14877,
                14915, 14953, 14990, 15027, 15063, 15099, 15135, 15170,
                15205, 15240, 15274, 15308, 15341, 15374, 15407, 15440,
                15472, 15504, 15535, 15566, 15597, 15628, 15659, 15689,
                15719, 15748, 15778, 15807, 15836, 15864, 15892, 15921,
                15948, 15976, 16003, 16031, 16058, 16084, 16111, 16137,
                16163, 16189, 16215, 16241, 16266, 16291, 16316, 16341,
                16365, 16390, 16414, 16438, 16462, 16486, 16509, 16533,
                16556, 16579, 16602, 16624, 16647, 16669, 16692, 16714,
                16736, 16758, 16779, 16801, 16822, 16844, 16865, 16886,
                16907, 16927, 16948, 16969, 16989, 17009, 17029, 17049,
                17069, 17089, 17109, 17128, 17148, 17167, 17186, 17205,
                17224, 17243, 17262, 17280, 17299, 17317, 17336, 17354,
                17372, 17390, 17408, 17426, 17444, 17462, 17479, 17497,
                17514, 17531, 17549, 17566, 17583, 17600, 17616, 17633,
                17650, 17667, 17683, 17700, 17716, 17732, 17748, 17765,
                17781, 17797, 17812, 17828, 17844, 17860, 17875, 17891,
                17906, 17922, 17937, 17952, 17967, 17983, 17998, 18013,
                18027, 18042, 18057, 18072, 18086, 18101, 18116, 18130,
                18144, 18159, 18173, 18187, 18201, 18215, 18229, 18243,
                18257, 18271, 18285, 18299, 18312, 18326, 18340, 18353,
                18367, 18380, 18393, 18407, 18420, 18433, 18446, 18459,
                18472, 18485, 18498, 18511, 18524, 18537, 18549, 18562,
                18575, 18587, 18600, 18612, 18625, 18637, 18650, 18662,
                18674, 18686, 18699, 18711, 18723, 18735, 18747, 18759,
                18771, 18783, 18794, 18806, 18818, 18830, 18841, 18853,
                18865, 18876, 18888, 18899, 18911, 18922, 18933, 18945,
                18956, 18967, 18978, 18989, 19001, 19012, 19023, 19034,
                19045, 19056, 19067, 19077, 19088, 19099, 19110, 19121,
                19131, 19142, 19152, 19163, 19174, 19184, 19195, 19205,
                19216, 19226, 19236, 19247, 19257, 19267, 19277, 19288,
                19298, 19308, 19318, 19328, 19338, 19348, 19358, 19368,
                19378, 19388, 19398, 19408, 19417, 19427, 19437, 19447,
                19456, 19466, 19476, 19485, 19495, 19505, 19514, 19524,
                19533, 19542, 19552, 19561, 19571, 19580, 19589, 19599,
                19608, 19617, 19626, 19636, 19645, 19654, 19663, 19672,
                19681, 19690, 19699, 19708, 19717, 19726, 19735, 19744,
                19753, 19762, 19770, 19779, 19788, 19797, 19805, 19814,
                19823, 19832, 19840, 19849, 19857, 19866, 19874, 19883,
                19892, 19900, 19908, 19917, 19925, 19934, 19942, 19950,
                19959, 19967, 19975, 19984, 19992, 20000, 20008, 20017,
                20025, 20033, 20041, 20049, 20057, 20065, 20073, 20081,
                20089, 20097, 20105, 20113, 20121, 20129, 20137, 20145,
                20153, 20161, 20169, 20176, 20184, 20192, 20200, 20207,
                20215, 20223, 20231, 20238, 20246, 20254, 20261, 20269,
                20276, 20284, 20291, 20299, 20306, 20314, 20321, 20329,
                20336, 20344, 20351, 20359, 20366, 20373, 20381, 20388,
                20395, 20403, 20410, 20417, 20424, 20432, 20439, 20446,
                20453, 20460, 20468, 20475, 20482, 20489, 20496, 20503,
                20510, 20517, 20524, 20531, 20538, 20545, 20552, 20559,
                20566, 20573, 20580, 20587, 20594, 20601, 20608, 20614,
                20621, 20628, 20635, 20642, 20648, 20655, 20662, 20669,
                20675, 20682, 20689, 20695, 20702, 20709, 20715, 20722,
                20729, 20735, 20742, 20748, 20755, 20762, 20768, 20775,
        },
        {
                1, 2, 1959, 3104, 3916, 4546, 5061, 5497,
                5874, 6206, 6504, 6773, 7019, 7245, 7454, 7649,
                7831, 8002, 8164, 8316, 8461, 8599, 8730, 8856,
                8976, 9091, 9202, 9309, 9411, 9511, 9606, 9699,
                9789, 9875, 9960, 10042, 10121, 10199, 10274, 10347,
                10419, 10488, 10556, 10623, 10688, 10751, 10813, 10874,
                10934, 10992, 11049, 11105, 11160, 11213, 11266, 11318,
                11369, 11419, 11468, 11516, 11564, 11610, 11656, 11701,
                11746, 11790, 11833, 11875, 11917, 11958, 11999, 12039,
                12079, 12118, 12156, 12194, 12231, 12268, 12305, 12341,
                12376, 12411, 12446, 12480, 12514, 12547, 12580, 12613,
                12645, 12677, 12709, 12740, 12771, 12801, 12832, 12861,
                12891, 12920, 12949, 12978, 13006, 13034, 13062, 13090,
                13117, 13144, 13171, 13197, 13224, 13250, 13275, 13301,
                13326, 13351, 13376, 13401, 13425, 13450, 13474, 13497,
                13521, 13545, 13568, 13591, 13614, 13636, 13659, 13681,
                13703, 13725, 13747, 13769, 13790, 13812, 13833, 13854,
                13875, 13895, 13916, 13936, 13956, 13977, 13996, 14016,
                14036, 14056, 14075, 14094, 14113, 14132, 14151, 14170,
                14189, 14207, 14226, 14244, 14262, 14280, 14298, 14316,
                14334, 14351, 14369, 14386, 14403, 14420, 14437, 14454,
                14471, 14488, 14505, 14521, 14538, 14554, 14570, 14587,
                14603, 14619, 14635, 14650, 14666, 14682, 14697, 14713,
                14728, 14744, 14759, 14774, 14789, 14804, 14819, 14834,
                14848, 14863, 14878, 14892, 14907, 14921, 14935, 14950,
                14964, 14978, 14992, 15006, 15020, 15033, 15047, 15061,
                15074, 15088, 15101, 15115, 15128, 15141, 15155, 15168,
                15181, 15194, 15207, 15220, 15233, 15246, 15258, 15271,
                15284, 15296, 15309, 15321, 15334, 15346, 15358, 15371,
                15383, 15395, 15407, 15419, 15431, 15443, 15455, 15467,
                15479, 15490, 15502, 15514, 15525, 15537, 15548, 15560,
                15571, 15582, 15594, 15605, 15616, 15627, 15639, 15650,
                15661, 15672, 15683, 15694, 15705, 15715, 15726, 15737,
                15748, 15758, 15769, 15780, 15790, 15801, 15811, 15822,
                15832, 15842, 15853, 15863, 15873, 15883, 15894, 15904,
                15914, 15924, 15934, 15944, 15954, 15964, 15974, 15984,
                15993, 16003, 16013, 16023, 16032, 16042, 16052, 16061,
                16071, 16080, 16090, 16099, 16109, 16118, 16127, 16137,
                16146, 16155, 16165, 16174, 16183, 16192, 16201, 16210,
                16219, 16228, 16237, 16246, 16255, 16264, 16273, 16282,
                16291, 16300, 16309, 16317, 16326, 16335, 16343, 16352,
                16361, 16369, 16378, 16386, 16395, 16403, 16412, 16420,
                16429, 16437, 16445, 16454, 16462, 16470, 16479, 16487,
                16495, 16503, 16512, 16520, 16528, 16536, 16544, 16552,
                16560, 16568, 16576, 16584, 16592, 16600, 16608, 16616,
                16624, 16631, 16639, 16647, 16655, 16662, 16670, 16678,
                16686, 16693, 16701, 16709, 16716, 16724, 16731, 16739,
                16746, 16754, 16761, 16769, 16776, 16784, 16791, 16798,
                16806, 16813, 16820, 16828, 16835, 16842, 16850, 16857,
                16864, 16871, 16878, 16886, 16893, 16900, 16907, 16914,
                16921, 16928, 16935, 16942, 16949, 16956, 16963, 16970,
                16977, 16984, 16991, 16998, 17005, 17011, 17018, 17025,
                17032, 17039, 17045, 17052, 17059, 17066, 17072, 17079,
                17086, 17092, 17099, 17106, 17112, 17119, 17125, 17132,
                17138, 17145, 17151, 17158, 17164, 17171, 17177, 17184,
                17190, 17197, 17203, 17209, 17216, 17222, 17228, 17235,
                17241, 17247, 17254, 17260, 17266, 17272, 17279, 17285,
                17291, 17297, 17303, 17310, 17316, 17322, 17328, 17334,
                17340, 17346, 17352, 17358, 17364, 17370, 17376, 17382,
                17388, 17394, 17400, 17406, 17412, 17418, 17424, 17430,
                17436, 17442, 17448, 17454, 17459, 17465, 17471, 17477,
                17483, 17488, 17494, 17500, 17506, 17511, 17517, 17523,
                17529, 17534, 17540, 17546, 17551, 17557, 17562, 17568,
                17574, 17579, 17585, 17590, 17596, 17602, 17607, 17613,
        },
};

#elif RENDER_SAMPLE_RATE == 11025
const uint32_t attackDurationTable[4][512] =
{
        {
                1, 2, 15611, 24741, 31220, 36245, 40351, 43822,
                46829, 49481, 51854, 54000, 55960, 57762, 59431, 60985,
                62438, 63803, 65090, 66308, 67463, 68562, 69609, 70610,
                71569, 72488, 73371, 74221, 75040, 75830, 76594, 77332,
                78047, 78740, 79412, 80065, 80700, 81317, 81917, 82502,
                83072, 83628, 84171, 84701, 85219, 85725, 86220, 86704,
                87178, 87642, 88097, 88543, 88981, 89409, 89830, 90244,
                90649, 91048, 91440, 91825, 92203, 92575, 92941, 93302,
                93656, 94006, 94349, 94688, 95022, 95350, 95674, 95994,
                96309, 96619, 96926, 97228, 97526, 97821, 98111, 98398,
                98681, 98961, 99237, 99510, 99780, 100047, 100310, 100570,
                100828, 101082, 101334, 101583, 101829, 102072, 102313, 102551,
                102787, 103021, 103251, 103480, 103706, 103931, 104152, 104372,
                104590, 104805, 105019, 105230, 105440, 105647, 105853, 106057,
                106259, 106459, 106657, 106854, 107049, 107242, 107434, 107624,
                107812, 107999, 108184, 108368, 108551, 108731, 108911, 109089,
                109266, 109441, 109615, 109787, 109958, 110128, 110297, 110465,
                110631, 110796, 110960, 111122, 111284, 111444, 111603, 111761,
                111918, 112074, 112229, 112382, 112535, 112687, 112837, 112987,
                113135, 113283, 113430, 113576, 113720, 113864, 114007, 114149,
                114291, 114431, 114570, 114709, 114847, 114984, 115120, 115255,
                115389, 115523, 115656, 115788, 115919, 116050, 116180, 116309,
                116437, 116564, 116691, 116817, 116943, 117068, 117192, 117315,
                117438, 117560, 117681, 117802, 117922, 118042, 118160, 118279,
                118396, 118513, 118630, 118745, 118861, 118975, 119089, 119203,
                119316, 119428, 119540, 119651, 119762, 119872, 119981, 120090,
                120199, 120307, 120414, 120521, 120628, 120734, 120839, 120944,
                121049, 121153, 121256, 121359, 121462, 121564, 121666, 121767,
                121868, 121968, 122068, 122167, 122266, 122365, 122463, 122561,
                122658, 122755, 122851, 122947, 123043, 123138, 123233, 123327,
                123421, 123515, 123608, 123701, 123794, 123886, 123977, 124069,
                124160, 124250, 124341, 124431, 124520, 124609, 124698, 124787,
                124875, 124962, 125050, 125137, 125224, 125310, 125396, 125482,
                125568, 125653, 125738, 125822, 125906, 125990, 126074, 126157,
                126240, 126323, 126405, 126487, 126569, 126650, 126731, 126812,
                126893, 126973, 127053, 127133, 127212, 127291, 127370, 127449,
                127527, 127605, 127683, 127760, 127838, 127915, 127991, 128068,
                128144, 128220, 128296, 128371, 128446, 128521, 128596, 128670,
                128745, 128819, 128892, 128966, 129039, 129112, 129185, 129257,
                129330, 129402, 129473, 129545, 129616, 129688, 129759, 129829,
                129900, 129970, 130040, 130110, 130179, 130249, 130318, 130387,
                130456, 130524, 130593, 130661, 130729, 130796, 130864, 130931,
                130998, 131065, 131132, 131199, 131265, 131331, 131397, 131463,
                131528, 131594, 131659, 131724, 131789, 131853, 131918, 131982,
                132046, 132110, 132174, 132237, 132300, 132364, 132427, 132489,
                132552, 132615, 132677, 132739, 132801, 132863, 132924, 132986,
                133047, 133108, 133169, 133230, 133290, 133351, 133411, 133471,
                133531, 133591, 133651, 133710, 133770, 133829, 133888, 133947,
                134005, 134064, 134122, 134181, 134239, 134297, 134355, 134412,
                134470, 134527, 134584, 134641, 134698, 134755, 134812, 134868,
                134925, 134981, 135037, 135093, 135149, 135204, 135260, 135315,
                135371, 135426, 135481, 135536, 135590, 135645, 135699, 135754,
                135808, 135862, 135916, 135970, 136023, 136077, 136130, 136184,
                136237, 136290, 136343, 136396, 136448, 136501, 136553, 136606,
                136658, 136710, 136762, 136814, 136865, 136917, 136968, 137020,
                137071, 137122, 137173, 137224, 137275, 137326, 137376, 137426,
                137477, 137527, 137577, 137627, 137677, 137727, 137776, 137826,
                137875, 137925, 137974, 138023, 138072, 138121, 138170, 138218,
                138267, 138316, 138364, 138412, 138460, 138508, 138556, 138604,
                138652, 138700, 138747, 138795, 138842, 138889, 138936, 138984,
                139030, 139077, 139124, 139171, 139217, 139264, 139310, 139357,
                139403, 139449, 139495, 139541, 139587, 139632, 139678, 139723,
                139769, 139814, 139860, 139905, 139950, 139995, 140040, 140084,
                140129, 140174, 140218, 140263, 140307, 140352, 140396, 140440,
        },
        {
                1, 2, 12452, 19735, 24902, 28911, 32186, 34954,
                37353, 39469, 41361, 43073, 44636, 46074, 47405, 48644,
                49803, 50892, 51919, 52890, 53812, 54688, 55524, 56322,
                57087, 57820, 58524, 59202, 59855, 60486, 61095, 61684,
                62254, 62807, 63343, 63864, 64370, 64862, 65341, 65807,
                66262, 66706, 67138, 67561, 67974, 68378, 68773, 69159,
                69537, 69907, 70270, 70626, 70975, 71317, 71653, 71982,
                72306, 72624, 72936, 73243, 73545, 73842, 74134, 74422,
                74704, 74983, 75257, 75527, 75793, 76056, 76314, 76569,
                76820, 77068, 77312, 77553, 77791, 78026, 78258, 78487,
                78713, 78936, 79156, 79374, 79589, 79802, 80012, 80219,
                80425, 80628, 80828, 81027, 81223, 81417, 81609, 81799,
                81987, 82174, 82358, 82540, 82721, 82899, 83076, 83252,
                83425, 83597, 83767, 83936, 84103, 84269, 84433, 84595,
                84756, 84916, 85074, 85231, 85387, 85541, 85694, 85845,
                85996, 86145, 86293, 86439, 86585, 86729, 86872, 87014,
                87155, 87295, 87433, 87571, 87708, 87843, 87978, 88111,
                88244, 88375, 88506, 88636, 88765, 88892, 89019, 89145,
                89271, 89395, 89518, 89641, 89763, 89884, 90004, 90123,
                90242, 90360, 90477, 90593, 90708, 90823, 90937, 91050,
                91163, 91275, 91386, 91497, 91607, 91716, 91824, 91932,
                92039, 92146, 92252, 92357, 92462, 92566, 92670, 92773,
                92875, 92977, 93078, 93179, 93279, 93378, 93477, 93576,
                93674, 93771, 93868, 93964, 94060, 94155, 94250, 94344,
                94438, 94531, 94624, 94716, 94808, 94900, 94991, 95081,
                95171, 95261, 95350, 95439, 95527, 95615, 95702, 95789,
                95876, 95962, 96048, 96133, 96218, 96302, 96387, 96470,
                96554, 96637, 96719, 96801, 96883, 96965, 97046, 97127,
                97207, 97287, 97367, 97446, 97525, 97603, 97682, 97760,
                97837, 97914, 97991, 98068, 98144, 98220, 98296, 98371,
                98446, 98521, 98595, 98669, 98743, 98817, 98890, 98963,
                99035, 99107, 99179, 99251, 99323, 99394, 99465, 99535,
                99605, 99675, 99745, 99815, 99884, 99953, 100022, 100090,
                100158, 100226, 100294, 100361, 100428, 100495, 100562, 100628,
                100694, 100760, 100826, 100891, 100957, 101022, 101086, 101151,
                101215, 101279, 101343, 101406, 101470, 101533, 101596, 101659,
                101721, 101783, 101845, 101907, 101969, 102030, 102091, 102152,
                102213, 102274, 102334, 102394, 102454, 102514, 102574, 102633,
                102692, 102751, 102810, 102869, 102927, 102985, 103043, 103101,
                103159, 103216, 103274, 103331, 103388, 103444, 103501, 103557,
                103614, 103670, 103725, 103781, 103837, 103892, 103947, 104002,
                104057, 104112, 104166, 104221, 104275, 104329, 104383, 104436,
                104490, 104543, 104597, 104650, 104703, 104755, 104808, 104860,
                104913, 104965, 105017, 105069, 105120, 105172, 105223, 105274,
                105326, 105376, 105427, 105478, 105529, 105579, 105629, 105679,
                105729, 105779, 105829, 105878, 105928, 105977, 106026, 106075,
                106124, 106173, 106221, 106270, 106318, 106366, 106414, 106462,
                106510, 106558, 106606, 106653, 106700, 106748, 106795, 106842,
                106888, 106935, 106982, 107028, 107075, 107121, 107167, 107213,
                107259, 107305, 107350, 107396, 107441, 107486, 107532, 107577,
                107622, 107667, 107711, 107756, 107800, 107845, 107889, 107933,
                107977, 108021, 108065, 108109, 108153, 108196, 108240, 108283,
                108326, 108369, 108412, 108455, 108498, 108541, 108583, 108626,
                108668, 108711, 108753, 108795, 108837, 108879, 108921, 108962,
                109004, 109046, 109087, 109128, 109170, 109211, 109252, 109293,
                109334, 109374, 109415, 109456, 109496, 109537, 109577, 109617,
                109657, 109697, 109737, 109777, 109817, 109857, 109896, 109936,
                109975, 110015, 110054, 110093, 110132, 110171, 110210, 110249,
                110288, 110326, 110365, 110403, 110442, 110480, 110518, 110557,
                110595, 110633, 110671, 110709, 110746, 110784, 110822, 110859,
                110897, 110934, 110971, 111009, 111046, 111083, 111120, 111157,
                111194, 111230, 111267, 111304, 111340, 111377, 111413, 111449,
                111486, 111522, 111558, 111594, 111630, 111666, 111702, 111737,
                111773, 111809, 111844, 111880, 111915, 111950, 111986, 112021,
        },
        {
                1, 2, 10412, 16502, 20823, 24174, 26913, 29228,
                31233, 33002, 34585, 36016, 37323, 38525, 39639, 40675,
                41644, 42555, 43413, 44225, 44996, 45728, 46427, 47095,
                47734, 48347, 48936, 49503, 50049, 50576, 51085, 51578,
                52055, 52517, 52965, 53401, 53824, 54235, 54636, 55026,
                55406, 55777, 56139, 56492, 56838, 57175, 57505, 57828,
                58145, 58454, 58758, 59055, 59347, 59633, 59914, 60189,
                60460, 60726, 60987, 61244, 61496, 61744, 61989, 62229,
                62465, 62698, 62928, 63153, 63376, 63595, 63811, 64024,
                64234, 64442, 64646, 64848, 65046, 65243, 65437, 65628,
                65817, 66003, 66188, 66370, 66550, 66727, 66903, 67077,
                67248, 67418, 67586, 67752, 67916, 68078, 68239, 68398,
                68555, 68711, 68865, 69017, 69168, 69318, 69466, 69612,
                69757, 69901, 70044, 70185, 70324, 70463, 70600, 70736,
                70870, 71004, 71136, 71267, 71398, 71526, 71654, 71781,
                71907, 72031, 72155, 72278, 72399, 72520, 72639, 72758,
                72876, 72993, 73109, 73224, 73338, 73452, 73564, 73676,
                73787, 73897, 74006, 74114, 74222, 74329, 74435, 74540,
                74645, 74749, 74852, 74955, 75057, 75158, 75258, 75358,
                75457, 75556, 75653, 75751, 75847, 75943, 76039, 76133,
                76227, 76321, 76414, 76507, 76598, 76690, 76780, 76871,
                76960, 77049, 77138, 77226, 77314, 77401, 77487, 77573,
                77659, 77744, 77829, 77913, 77997, 78080, 78162, 78245,
                78327, 78408, 78489, 78570, 78650, 78729, 78809, 78887,
                78966, 79044, 79121, 79199, 79276, 79352, 79428, 79504,
                79579, 79654, 79728, 79803, 79876, 79950, 80023, 80096,
                80168, 80240, 80312, 80383, 80454, 80525, 80595, 80665,
                80735, 80804, 80873, 80942, 81010, 81079, 81146, 81214,
                81281, 81348, 81415, 81481, 81547, 81613, 81678, 81743,
                81808, 81873, 81937, 82001, 82065, 82128, 82192, 82255,
                82317, 82380, 82442, 82504, 82566, 82627, 82688, 82749,
                82810, 82870, 82930, 82990, 83050, 83110, 83169, 83228,
                83287, 83345, 83404, 83462, 83520, 83577, 83635, 83692,
                83749, 83806, 83862, 83919, 83975, 84031, 84086, 84142,
                84197, 84252, 84307, 84362, 84416, 84471, 84525, 84579,
                84633, 84686, 84739, 84793, 84846, 84898, 84951, 85003,
                85056, 85108, 85160, 85211, 85263, 85314, 85365, 85416,
                85467, 85518, 85568, 85619, 85669, 85719, 85769, 85818,
                85868, 85917, 85966, 86015, 86064, 86113, 86161, 86210,
                86258, 86306, 86354, 86402, 86449, 86497, 86544, 86591,
                86638, 86685, 86732, 86778, 86825, 86871, 86917, 86963,
                87009, 87055, 87100, 87146, 87191, 87236, 87281, 87326,
                87371, 87416, 87460, 87504, 87549, 87593, 87637, 87681,
                87724, 87768, 87811, 87855, 87898, 87941, 87984, 88027,
                88070, 88112, 88155, 88197, 88239, 88281, 88323, 88365,
                88407, 88449, 88490, 88532, 88573, 88614, 88655, 88696,
                88737, 88778, 88819, 88859, 88900, 88940, 88980, 89020,
                89060, 89100, 89140, 89180, 89219, 89259, 89298, 89337,
                89376, 89416, 89455, 89493, 89532, 89571, 89609, 89648,
                89686, 89724, 89763, 89801, 89839, 89877, 89914, 89952,
                89990, 90027, 90065, 90102, 90139, 90176, 90213, 90250,
                90287, 90324, 90360, 90397, 90434, 90470, 90506, 90543,
                90579, 90615, 90651, 90687, 90722, 90758, 90794, 90829,
                90865, 90900, 90935, 90971, 91006, 91041, 91076, 91111,
                91146, 91180, 91215, 91249, 91284, 91318, 91353, 91387,
                91421, 91455, 91489, 91523, 91557, 91591, 91625, 91658,
                91692, 91725, 91759, 91792, 91825, 91858, 91892, 91925,
                91958, 91990, 92023, 92056, 92089, 92121, 92154, 92186,
                92219, 92251, 92283, 92316, 92348, 92380, 92412, 92444,
                92476, 92507, 92539, 92571, 92602, 92634, 92665, 92697,
                92728, 92759, 92790, 92822, 92853, 92884, 92915, 92945,
                92976, 93007, 93038, 93068, 93099, 93129, 93160, 93190,
                93220, 93251, 93281, 93311, 93341, 93371, 93401, 93431,
                93461, 93491, 93520, 93550, 93580, 93609, 93639, 93668,
        },
        {
                1, 2, 8831, 13996, 17661, 20503, 22826, 24789,
                26490, 27991, 29333, 30547, 31655, 32675, 33619, 34498,
                35320, 36092, 36820, 37509, 38163, 38784, 39377, 39943,
                40485, 41005, 41505, 41985, 42449, 42896, 43328, 43745,
                44150, 44542, 44922, 45291, 45650, 45999, 46339, 46670,
                46992, 47307, 47614, 47913, 48206, 48493, 48773, 49046,
                49315, 49577, 49835, 50087, 50334, 50577, 50815, 51049,
                51278, 51504, 51725, 51943, 52157, 52368, 52575, 52779,
                52979, 53177, 53371, 53563, 53752, 53938, 54121, 54301,
                54480, 54655, 54829, 55000, 55168, 55335, 55499, 55662,
                55822, 55980, 56136, 56291, 56443, 56594, 56743, 56890,
                57036, 57180, 57322, 57463, 57602, 57740, 57876, 58011,
                58144, 58276, 58407, 58536, 58664, 58791, 58917, 59041,
                59164, 59286, 59407, 59526, 59645, 59762, 59878, 59994,
                60108, 60221, 60333, 60445, 60555, 60664, 60773, 60880,
                60987, 61092, 61197, 61301, 61404, 61507, 61608, 61709,
                61809, 61908, 62006, 62104, 62201, 62297, 62392, 62487,
                62581, 62674, 62767, 62859, 62950, 63041, 63131, 63221,
                63309, 63397, 63485, 63572, 63658, 63744, 63829, 63914,
                63998, 64082, 64165, 64247, 64329, 64410, 64491, 64572,
                64651, 64731, 64810, 64888, 64966, 65043, 65120, 65197,
                65273, 65349, 65424, 65498, 65573, 65647, 65720, 65793,
                65866, 65938, 66009, 66081, 66152, 66222, 66293, 66362,
                66432, 66501, 66569, 66638, 66706, 66773, 66841, 66907,
                66974, 67040, 67106, 67171, 67237, 67301, 67366, 67430,
                67494, 67557, 67621, 67684, 67746, 67808, 67870, 67932,
                67994, 68055, 68115, 68176, 68236, 68296, 68356, 68415,
                68474, 68533, 68592, 68650, 68708, 68766, 68823, 68881,
                68938, 68994, 69051, 69107, 69163, 69219, 69274, 69330,
                69385, 69439, 69494, 69548, 69602, 69656, 69710, 69763,
                69816, 69869, 69922, 69975, 70027, 70079, 70131, 70183,
                70234, 70285, 70336, 70387, 70438, 70488, 70539, 70589,
                70639, 70688, 70738, 70787, 70836, 70885, 70934, 70982,
                71031, 71079, 71127, 71174, 71222, 71270, 71317, 71364,
                71411, 71458, 71504, 71551, 71597, 71643, 71689, 71734,
                71780, 71825, 71871, 71916, 71961, 72006, 72050, 72095,
                72139, 72183, 72227, 72271, 72315, 72358, 72402, 72445,
                72488, 72531, 72574, 72616, 72659, 72701, 72744, 72786,
                72828, 72869, 72911, 72953, 72994, 73035, 73077, 73118,
                73159, 73199, 73240, 73280, 73321, 73361, 73401, 73441,
                73481, 73521, 73560, 73600, 73639, 73679, 73718, 73757,
                73796, 73834, 73873, 73912, 73950, 73988, 74027, 74065,
                74103, 74140, 74178, 74216, 74253, 74291, 74328, 74365,
                74402, 74439, 74476, 74513, 74550, 74586, 74623, 74659,
                74695, 74731, 74767, 74803, 74839, 74875, 74910, 74946,
                74981, 75017, 75052, 75087, 75122, 75157, 75192, 75227,
                75261, 75296, 75330, 75365, 75399, 75433, 75467, 75501,
                75535, 75569, 75603, 75637, 75670, 75704, 75737, 75770,
                75804, 75837, 75870, 75903, 75936, 75968, 76001, 76034,
                76066, 76099, 76131, 76163, 76196, 76228, 76260, 76292,
                76324, 76355, 76387, 76419, 76450, 76482, 76513, 76545,
                76576, 76607, 76638, 76669, 76700, 76731, 76762, 76793,
                76823, 76854, 76884, 76915, 76945, 76975, 77006, 77036,
                77066, 77096, 77126, 77156, 77185, 77215, 77245, 77274,
                77304, 77333, 77363, 77392, 77421, 77451, 77480, 77509,
                77538, 77567, 77595, 77624, 77653, 77682, 77710, 77739,
                77767, 77796, 77824, 77852, 77880, 77909, 77937, 77965,
                77993, 78021, 78048, 78076, 78104, 78132, 78159, 78187,
                78214, 78242, 78269, 78296, 78324, 78351, 78378, 78405,
                78432, 78459, 78486, 78513, 78539, 78566, 78593, 78619,
                78646, 78673, 78699, 78725, 78752, 78778, 78804, 78830,
                78857, 78883, 78909, 78935, 78961, 78986, 79012, 79038,
                79064, 79089, 79115, 79141, 79166, 79192, 79217, 79242,
                79268, 79293, 79318, 79343, 79368, 79393, 79418, 79443,
        },
};

static const float attack_const [16][4] =
{
    { 1 ,  1 ,  1 ,  1 },
    { 0.999799875 ,  0.999748941 ,  0.999699828 ,  0.99964596  },
    { 0.999599791 ,  0.999497945 ,  0.999399746 ,  0.999292046 },
    { 0.999199741 ,  0.998996141 ,  0.998799852 ,  0.998584594 },
    { 0.998400123 ,  0.997993291 ,  0.997601145 ,  0.997171191 },
    { 0.996802806 ,  0.995990608 ,  0.995208044 ,  0.994350383 },
    { 0.993615834 ,  0.991997291 ,  0.990439051 ,  0.988732685 },
    { 0.987272425 ,  0.984058626 ,  0.980969514 ,  0.977592322 },
    { 0.974706842 ,  0.96837138  ,  0.962301188 ,  0.955686748 },
    { 0.950053427 ,  0.93774313  ,  0.926023576 ,  0.913337161 },
    { 0.902601515 ,  0.879362177 ,  0.857519663 ,  0.83418477  },
    { 0.814689494 ,  0.773277838 ,  0.735339972 ,  0.695864231 },
    { 0.663718972 ,  0.597958615 ,  0.540724874 ,  0.484227027 },
    { 0.440522874 ,  0.357554506 ,  0.292383389 ,  0.234475814 },
    { 0.194060403 ,  0.127845225 ,  0.085488046 ,  0.054978907 },
    { 0 ,  0 ,  0 ,  0 },
};
static const float decay_release_const[16][4] =
{
    {0, 0, 0, 0},
    {0.001182262,    0.00147821,    0.001774314,    0.002068954},
    {0.002364525,    0.002956419,    0.003548629,    0.004137908},
    {0.00472905,    0.005912839,    0.007097257,    0.008275816},
    {0.0094581,    0.011825678,    0.014194515,    0.016551633},
    {0.0189162,    0.023651355,    0.028389029,    0.033103266},
    {0.0378324,    0.047302711,    0.056778058,    0.066206531},
    {0.0756648,    0.094605421,    0.113556116,    0.132413063},
    {0.1513296,    0.189210843,    0.227112232,    0.264826125},
    {0.302659199,    0.378421686,    0.454224465,    0.52965225},
    {0.605318398,    0.756843372,    0.90844893,    1.0593045},
    {1.210636797,    1.513686744,    1.81689786,    2.118609001},
    {2.421273593,    3.027373487,    3.63379572,    4.237218002},
    {4.842547187,    6.054746975,    7.267591439,    8.474436003},
    {9.685094374,    12.10949395,    14.53518288,    16.94887201},
    {19.37018875,    19.37018875,    19.37018875,    19.37018875}
};
#else
#error unsupported sps
#endif
//
// freq mult table multiplied by 2
//
// 1/2, 1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 10, 12, 12, 15, 15
//
const float conversionFactor = ORIGINAL_SAMPLE_RATE / (float) RENDER_SAMPLE_RATE;
const float invConversionFactor = RENDER_SAMPLE_RATE / (float) ORIGINAL_SAMPLE_RATE ;
//
#define CHIP_TIMER_FIXED_POINT_FRACT_BITS       16
#define PG_PRECISION                            (9 + 12)
#define TREMOLO_PRECISION                       12          // can be 16 for small buffers
#define FEEDBACK_CORRECTION_PRECISION           14
#define mtMult                                  (( 1 << (PG_PRECISION - 9 - 2)) * conversionFactor)
//
static const Bit32u mt[16] = {
    1 * mtMult,
    2 * mtMult,
    4 * mtMult,
    6 * mtMult,
    8 * mtMult,
    10 * mtMult,
    12 * mtMult,
    14 * mtMult,
    16 * mtMult,
    18 * mtMult,
    20 * mtMult,
    20 * mtMult,
    24 * mtMult,
    24 * mtMult,
    30 * mtMult,
    30 * mtMult
};


//
// ksl table
//

static const Bit8u kslrom[16] = {
    0, 32, 40, 45, 48, 51, 53, 55, 56, 58, 59, 60, 61, 62, 63, 64
};

static const Bit8u kslshift[4] = {
    8, 1, 2, 0
};

//
// address decoding
//
static const int8_t ad_slot[0x20] =
{
    0, 2, 4, 1, 3, 5, -1, -1, 6, 8, 10, 7, 9, 11, -1, -1, 12, 14, 16, 13, 15, 17, -1, -1, -1, -1, -1, -1, -1, 1, -1, -1
};

//
// Envelope generator
//
typedef Bit16s(*envelope_sinfunc)(Bit16u phase, Bit16u envelope);
typedef void(*envelope_genfunc)(opl2_slot *slott);

#if USE_OLD_EXP_TABLE
  #define OPL2_EnvelopeCalcExp(level) ((level) > /*0x1fff*/ 0xCff ? 0 : (exprom[(level) & 0xff] << 1) >> ((level) >> 8))
#else
  #define OPL2_EnvelopeCalcExp(level) (level >= sizeof(longExpTable)/sizeof(longExpTable[0]) ? 0 : longExpTable[level])
#endif
enum envelope_gen_num
{
    envelope_gen_num_off = 0,
    envelope_gen_num_attack = 1,
    envelope_gen_num_decay = 2,
    envelope_gen_num_sustain = 3,
    envelope_gen_num_release = 4
};

//#error check if keyon and instant attack or release can be calculated when keyOn/Off message is received...
// not used during rendition, no need of using tables.
static void OPL2_EnvelopeUpdateKSL(opl2_slot *slot)
{
    Bit16s ksl = (kslrom[chip->channel[slot->chanNum].f_num >> 6] << 2) - ((0x08 - chip->channel[slot->chanNum].block) << 5);
    if (ksl < 0)
    {
        ksl = 0;
    }
    slot->tl_ksl_add = (slot->bits_tl << 2) + ((Bit8u)ksl >> kslshift[slot->bits_ksl]);
    slot->ks = chip->channel[slot->chanNum].ksv >> ((slot->bit_ksr ^ 1) << 1);      // ksv is 4 bit at most

}
/**
 *  @brief Function to generate operator waveform.
    This function is inlined and called many times to be hopefully optimized by the compiler
     to prevent checking the various switches many times
*/
__attribute__((always_inline)) static inline uint32_t OPL2_GenerateWaveworm(opl2_slot *slot,
                                         int32_t *dstBuffer,
                                         int16_t *modBuffer,
                                         const uint32_t maxNumSamples,
                                         const uint8_t eg_state,
                                         const bool hasFeedback,
                                         const bool hasVibrato,
                                         const bool hasTremolo,
                                         const bool isModulator,
                                         const bool isPhaseModulated)
{
    uint32_t numSamples;
    const int32_t * waveformMod = slot->waveformMod;
    uint32_t f_numBack = chip->channel[slot->chanNum].f_num;
    // get initial phase (with precision bits) value.
    uint32_t pg_phase = slot->pg_phase;
    uint32_t nineMinusFb;
    uint32_t mt_number = mt[slot->bits_mult] <<  chip->channel[slot->chanNum].block;
    int16_t previousOut;
    int16_t currentOut;
    float eg_const_f;
    uint8_t rate;
    bool willThisEgPhaseFinish = false;
    float eg_rout_f = slot->eg_rout_f;
    const uint8_t *tremTable;
    uint32_t chipTimerFixedPoint;
    uint32_t tremolopos;
    uint32_t basefreq;
    if (hasTremolo)
    {
        tremTable = chip->tremoloTable;
        tremolopos = chip->tremolopos;

    }
    if (hasVibrato)
    {
      chipTimerFixedPoint = chip->timerFixedPoint;
    }
    else
    {
         basefreq = f_numBack * mt_number;
    }
    if (envelope_gen_num_attack == eg_state)
    {
        rate = slot->ks + (slot->bits_ar << 2);
        uint32_t rate_hi = rate >> 2;
        if (rate_hi >= 0xF)
        {
            rate_hi = 0xF;
            numSamples = 1;
        }
        else
        {
            if (rate_hi)
            {
                numSamples = 1 + (attackDurationTable[rate & 3][(int)eg_rout_f] >> (rate_hi - 1));
            }
            else
            {   // rate hi = 0: last forever
                numSamples = maxNumSamples;
            }
        }
        eg_const_f = attack_const[rate_hi][rate & 3];
        if (numSamples <= maxNumSamples)
        {
            willThisEgPhaseFinish = true;
        }
        else
        {
           numSamples = maxNumSamples;
        }
    }
    else if (envelope_gen_num_release == eg_state || envelope_gen_num_decay == eg_state )
    {
        uint32_t stopLevel;
        if (envelope_gen_num_release == eg_state)
        {   // release
            rate = slot->ks + (slot->bits_rr << 2);
            stopLevel = 0x1FF;      // release will end at maximum attenuation
        }
        else
        {   // decay
            rate = slot->ks + (slot->bits_dr << 2);
            stopLevel = slot->bits_sl << 4;
        }
        uint32_t rate_hi = rate >> 2;
        if (rate_hi > 0xF)
        {
            rate_hi = 0xF;
        }
        eg_const_f = decay_release_const[rate_hi][rate & 3];

        if (rate_hi)
        {
            numSamples = (stopLevel - eg_rout_f ) / eg_const_f;
            if (numSamples <= maxNumSamples)
            {
                willThisEgPhaseFinish = true;
            }
            else
            {
               numSamples = maxNumSamples;
            }
        }
        else
        {   // the release constant is 0.
            numSamples = maxNumSamples;
        }
    }
    else
    {   // sustain.
        numSamples = maxNumSamples;
    }

    if (hasFeedback)
    {
        currentOut = slot->out;
        previousOut = slot->prout;

        #if RENDER_SAMPLE_RATE != 49716
            nineMinusFb = chip->channel[slot->chanNum].nineMinusFb + FEEDBACK_CORRECTION_PRECISION;
      #else
            nineMinusFb = chip->channel[slot->chanNum].nineMinusFb;
        #endif
    }
    uint32_t tl_ksl_add = slot->tl_ksl_add;
    for (uint32_t s = 0; s < numSamples; s++)
    {
        int32_t fbmod;
        // CALCULATE FEEDBACK
        if (hasFeedback)
        {
            // Note: this is not good at sample rate different from 49716
            #if RENDER_SAMPLE_RATE == 49716
                fbmod = (previousOut + currentOut) >> nineMinusFb;//(0x09 - slot->channel->fb);
            #else
                // unfortunately, we cannot get the real previous sample output, because we are sampling too slow
                // but we can interpolate: better than nothing.
                //fbmod = (currentOut - (int16_t) ((currentOut - previousOut) * invConversionFactor)) >> nineMinusFb;
                fbmod = ((currentOut << FEEDBACK_CORRECTION_PRECISION) - (currentOut - previousOut) * (int32_t) ( (1 << FEEDBACK_CORRECTION_PRECISION) * invConversionFactor)) >> nineMinusFb;

            #endif
        }
        previousOut = currentOut;
        // CALCULATE ENVELOPE
        uint32_t eg_out;
        if (hasTremolo)
        {
            tremolopos += ((1 << TREMOLO_PRECISION ) * (conversionFactor * 256.0f / 210.0f));
            eg_out = (int) eg_rout_f + tl_ksl_add + tremTable[(tremolopos >> (6 + TREMOLO_PRECISION)) & 0xFF]; // the 6 comes out because each element is repeated 64 clk
        }
        else
        {
            eg_out = (int) eg_rout_f + tl_ksl_add;
        }
        if (envelope_gen_num_attack == eg_state)
        {
            eg_rout_f *= eg_const_f;
        }
        else if (envelope_gen_num_release == eg_state || envelope_gen_num_decay == eg_state )
        {
            eg_rout_f += eg_const_f;
        }
        else
        {
            // sustain or off: no change in amplitude.
        }
        // GENERATE PHASE
        if (hasVibrato)
        {   // if has vibrato, then fnum must be calculated every time
          //uint32_t f_num = f_numBack;
          // update chiptimer
          chipTimerFixedPoint += (uint32_t) ( (1 << CHIP_TIMER_FIXED_POINT_FRACT_BITS) * conversionFactor);
          uint32_t vibpos = 0x7 & (chipTimerFixedPoint >> (10 + CHIP_TIMER_FIXED_POINT_FRACT_BITS));
            //f_num += slot->vib_table[vibpos];
            basefreq = f_numBack + slot->vib_table[vibpos];
            pg_phase += basefreq * mt_number;
        }
        else
        {
          pg_phase += basefreq;
        }
        // change phase
        uint32_t phase;
        // GENERATE OUTPUT
        if (isPhaseModulated)
        {
            phase = (pg_phase >> PG_PRECISION) + modBuffer[s];//
        }
        else if (hasFeedback)
        {
            phase = (pg_phase >> PG_PRECISION) + fbmod;//
        }
        else

        {
             phase = (pg_phase >> PG_PRECISION);
        }
#define SMART_ENV_CALC 1
#if SMART_ENV_CALC == 1
        uint32_t level = logsinrom[phase & 0x1ff] + (eg_out << 3);
        if (level >=sizeof(longExpTable)/sizeof(longExpTable[0]))
           currentOut = 0;
        else
          currentOut =  waveformMod[(phase >> 8) & 3] * longExpTable[level];
  #elif SMART_ENV_CALC == 2
        uint32_t wf = waveformMod[(phase >> 8) & 3];
        uint32_t level = logsinrom[phase & 0x1ff] + (eg_out << 3);
        if (wf == 0 || level >=sizeof(longExpTable)/sizeof(longExpTable[0]))
           currentOut = 0;
        else
          currentOut =   wf * longExpTable[level];
  #else
        currentOut = waveformMod[(phase >> 8) & 3] * OPL2_EnvelopeCalcExp(logsinrom[phase & 0x1ff] + (eg_out << 3));
#endif
        if (isModulator)
        {
            *modBuffer++ = currentOut;
        }
        else
        {
            *dstBuffer = *dstBuffer + currentOut;
            dstBuffer++;
        }
    }
    // END: we need to update slot state.
    // UPDATE FINAL PHASE
    slot->pg_phase = pg_phase;
    // UPDATE FINAL eg_rout_f
    slot->eg_rout_f = eg_rout_f;
    // update current and previous output state. Used only for feedback
    if (hasFeedback)
    {
        slot->out = currentOut;
        slot->prout = previousOut;
    }
    if (willThisEgPhaseFinish)
    {

        if (envelope_gen_num_decay == eg_state)
        {
            slot->eg_rout_f = slot->bits_sl << 4;
            slot->eg_gen = envelope_gen_num_sustain;
        }
        if (envelope_gen_num_release == eg_state)
        {
            slot->eg_rout_f = 0x1FF;
            slot->eg_gen = envelope_gen_num_off;
        }
        if (envelope_gen_num_attack == eg_state)
        {
            slot->eg_rout_f = 0;
            slot->eg_gen = envelope_gen_num_decay;
        }
    }
    // store to chip the tremolo and timer
    if (hasTremolo)
    {
        chip->tremolopos = tremolopos;

    }
    if (hasVibrato)
    {
      chip->timerFixedPoint = chipTimerFixedPoint;
    }
    return numSamples;
}
__attribute__((always_inline))  static inline void OPL2_SlotGenerateParametric(opl2_slot *slot,
                                             int32_t *dstBuffer,
                                             int16_t *modBuffer,
                                             const uint32_t numsamples,
                                             const bool hasFeedback,
                                             const bool hasVibrato,
                                             const bool hasTremolo,
                                             const bool isModulator,
                                             const bool isPhaseModulated)
{
    uint32_t chipTimerFixedPointBkp = chip->timerFixedPoint;
    uint32_t chipTremoloPosBkp = chip->tremolopos;
    uint32_t s = 0;
    int numSamplesForCurrentPhase;
    while (s < numsamples)
    {
        // algorithm 1: sum of two waveforms
        switch (slot->eg_gen)
        {
            default:
            case envelope_gen_num_off:
                // silence
                numSamplesForCurrentPhase = numsamples - s;
                if (isModulator)
                {
                    for ( ; s < numsamples; s++)
                        modBuffer[s] = 0;
                }
            break;
            case envelope_gen_num_attack:
            {

                numSamplesForCurrentPhase = OPL2_GenerateWaveworm(
                                                                     slot,
                                                                     &dstBuffer[s],
                                                                     &modBuffer[s],
                                                                     numsamples - s,
                                                                     envelope_gen_num_attack,
                                                                     hasFeedback,
                                                                     hasVibrato,
                                                                     hasTremolo,
                                                                     isModulator,
                                                                     isPhaseModulated
                                                                 );
            }
            break;
            case envelope_gen_num_decay:
            {
                numSamplesForCurrentPhase = OPL2_GenerateWaveworm(
                                             slot,
                                             &dstBuffer[s],
                                             &modBuffer[s],
                                             numsamples - s,
                                             envelope_gen_num_decay,
                                             hasFeedback,
                                             hasVibrato,
                                             hasTremolo,
                                             isModulator,
                                             isPhaseModulated
                                         );

            }
            break;
            case envelope_gen_num_release:
            {
                numSamplesForCurrentPhase = OPL2_GenerateWaveworm(
                                             slot,
                                             &dstBuffer[s],
                                             &modBuffer[s],
                                             numsamples - s,
                                             envelope_gen_num_release,
                                             hasFeedback,
                                             hasVibrato,
                                             hasTremolo,
                                             isModulator,
                                             isPhaseModulated
                                         );
            }
            break;
            case envelope_gen_num_sustain:
            if (!slot->bit_sustain)
            {   // if there is no sustain phase, then go directly to release
                numSamplesForCurrentPhase = 0;
                slot->eg_gen = envelope_gen_num_release;
            }
            else
            {
                // else just generate the remaining samples with 0 rate
                numSamplesForCurrentPhase = OPL2_GenerateWaveworm(
                                             slot,
                                             &dstBuffer[s],
                                             &modBuffer[s],
                                             numsamples - s,
                                             envelope_gen_num_sustain,
                                             hasFeedback,
                                             hasVibrato,
                                             hasTremolo,
                                             isModulator,
                                             isPhaseModulated
                                         );

            }
            break;
        }
        s += numSamplesForCurrentPhase;
//        chipTimerFixedPoint += numSamplesForCurrentPhase * (1 << CHIP_TIMER_FIXED_POINT_FRACT_BITS) * conversionFactor;
//        chipTremoloPos += numSamplesForCurrentPhase * (1 << TREMOLO_PRECISION ) * (conversionFactor * 256.0f / 210.0f);
    }
    // restore values
    chip->timerFixedPoint = chipTimerFixedPointBkp;
    chip->tremolopos = chipTremoloPosBkp;
}

void OPL2_GenerateStream(int32_t * buffer, uint32_t numsamples)
{
    int16_t modBuffer[MUSIC_NUM_SAMPLES];
    // clear buffer.
    for (uint32_t i = 0; i < numsamples; i++)
    {
        buffer[i] = 0;
    }

    for (int ch = 0; ch < 9; ch ++)
    {
        //for (uint8_t slotN = 0 ; slotN < 2; slotN++)
        {
            opl2_slot * slot;
            uint8_t nineMinusFb;
            // slot 0.

            slot = chip->channel[ch].slots[0];
            nineMinusFb = chip->channel[ch].nineMinusFb;
            if ((!chip->channel[ch].alg))
            {
                const bool isModulator = true;
                const bool isPhaseModulated = false;        // slot 0 is not phase modulated

                if (nineMinusFb != 0x09)  // slot 0 can have feedback
                {
                    const bool hasFeedback = true;
                    if (slot->bit_vib)      // all slots can have vibrato
                    {
                        const bool hasVibrato = true;
                        // inner check
                        if (slot->bit_trem) // all slots can have tremolo
                        {
                            const  bool hasTremolo = true;
                            OPL2_SlotGenerateParametric(slot, buffer, modBuffer, numsamples, hasFeedback, hasVibrato, hasTremolo, isModulator, isPhaseModulated);
                        }
                        else
                        {
                            const  bool hasTremolo = false;
                            OPL2_SlotGenerateParametric(slot, buffer, modBuffer, numsamples, hasFeedback, hasVibrato, hasTremolo, isModulator, isPhaseModulated);
                        }
                    }
                    else
                    {
                        const bool hasVibrato = false;
                        // inner check
                        if (slot->bit_trem) // all slots can have tremolo
                        {
                            const  bool hasTremolo = true;
                            OPL2_SlotGenerateParametric(slot, buffer, modBuffer, numsamples, hasFeedback, hasVibrato, hasTremolo, isModulator, isPhaseModulated);
                        }
                        else
                        {
                            const  bool hasTremolo = false;
                            OPL2_SlotGenerateParametric(slot, buffer, modBuffer, numsamples, hasFeedback, hasVibrato, hasTremolo, isModulator, isPhaseModulated);
                        }
                    }
                }
                else
                {
                    const bool hasFeedback = false;
                    if (slot->bit_vib)      // all slots can have vibrato
                    {
                        const bool hasVibrato = true;
                        // inner check
                        if (slot->bit_trem) // all slots can have tremolo
                        {
                            const  bool hasTremolo = true;
                            OPL2_SlotGenerateParametric(slot, buffer, modBuffer, numsamples, hasFeedback, hasVibrato, hasTremolo, isModulator, isPhaseModulated);
                        }
                        else
                        {
                            const  bool hasTremolo = false;
                            OPL2_SlotGenerateParametric(slot, buffer, modBuffer, numsamples, hasFeedback, hasVibrato, hasTremolo, isModulator, isPhaseModulated);
                        }
                    }
                    else
                    {
                        const bool hasVibrato = false;
                        // inner check
                        if (slot->bit_trem) // all slots can have tremolo
                        {
                            const  bool hasTremolo = true;
                            OPL2_SlotGenerateParametric(slot, buffer, modBuffer, numsamples, hasFeedback, hasVibrato, hasTremolo, isModulator, isPhaseModulated);
                        }
                        else
                        {
                            const  bool hasTremolo = false;
                            OPL2_SlotGenerateParametric(slot, buffer, modBuffer, numsamples, hasFeedback, hasVibrato, hasTremolo, isModulator, isPhaseModulated);
                        }
                    }
                }
            }
            else
            {
                const bool isModulator = false;
                const bool isPhaseModulated = false;        // slot 0 is not phase modulated

                if (nineMinusFb != 0x09)  // slot 0 can have feedback
                {
                    const bool hasFeedback = true;
                    if (slot->bit_vib)      // all slots can have vibrato
                    {
                        const bool hasVibrato = true;
                        // inner check
                        if (slot->bit_trem) // all slots can have tremolo
                        {
                            const  bool hasTremolo = true;
                            OPL2_SlotGenerateParametric(slot, buffer, modBuffer, numsamples, hasFeedback, hasVibrato, hasTremolo, isModulator, isPhaseModulated);
                        }
                        else
                        {
                            const  bool hasTremolo = false;
                            OPL2_SlotGenerateParametric(slot, buffer, modBuffer, numsamples, hasFeedback, hasVibrato, hasTremolo, isModulator, isPhaseModulated);
                        }
                    }
                    else
                    {
                        const bool hasVibrato = false;
                        // inner check
                        if (slot->bit_trem) // all slots can have tremolo
                        {
                            const  bool hasTremolo = true;
                            OPL2_SlotGenerateParametric(slot, buffer, modBuffer, numsamples, hasFeedback, hasVibrato, hasTremolo, isModulator, isPhaseModulated);
                        }
                        else
                        {
                            const  bool hasTremolo = false;
                            OPL2_SlotGenerateParametric(slot, buffer, modBuffer, numsamples, hasFeedback, hasVibrato, hasTremolo, isModulator, isPhaseModulated);
                        }
                    }
                }
                else
                {
                    const bool hasFeedback = false;
                    if (slot->bit_vib)      // all slots can have vibrato
                    {
                        const bool hasVibrato = true;
                        // inner check
                        if (slot->bit_trem) // all slots can have tremolo
                        {
                            const  bool hasTremolo = true;
                            OPL2_SlotGenerateParametric(slot, buffer, modBuffer, numsamples, hasFeedback, hasVibrato, hasTremolo, isModulator, isPhaseModulated);
                        }
                        else
                        {
                            const  bool hasTremolo = false;
                            OPL2_SlotGenerateParametric(slot, buffer, modBuffer, numsamples, hasFeedback, hasVibrato, hasTremolo, isModulator, isPhaseModulated);
                        }
                    }
                    else
                    {
                        const bool hasVibrato = false;
                        // inner check
                        if (slot->bit_trem) // all slots can have tremolo
                        {
                            const  bool hasTremolo = true;
                            OPL2_SlotGenerateParametric(slot, buffer, modBuffer, numsamples, hasFeedback, hasVibrato, hasTremolo, isModulator, isPhaseModulated);
                        }
                        else
                        {
                            const  bool hasTremolo = false;
                            OPL2_SlotGenerateParametric(slot, buffer, modBuffer, numsamples, hasFeedback, hasVibrato, hasTremolo, isModulator, isPhaseModulated);
                        }
                    }
                }
            }
            //
            // slot 1. No feedback
            //
            slot = chip->channel[ch].slots[1];
            nineMinusFb = chip->channel[ch].nineMinusFb;
            if ((!chip->channel[ch].alg))
            {
                const bool isModulator = false;             // algorithm 0 FM
                const bool isPhaseModulated = true;        //
                const bool hasFeedback = false;         // slot never has feedback
                if (slot->bit_vib)      // all slots can have vibrato
                {
                    const bool hasVibrato = true;
                    // inner check
                    if (slot->bit_trem) // all slots can have tremolo
                    {
                        const  bool hasTremolo = true;
                        OPL2_SlotGenerateParametric(slot, buffer, modBuffer, numsamples, hasFeedback, hasVibrato, hasTremolo, isModulator, isPhaseModulated);
                    }
                    else
                    {
                        const  bool hasTremolo = false;
                        OPL2_SlotGenerateParametric(slot, buffer, modBuffer, numsamples, hasFeedback, hasVibrato, hasTremolo, isModulator, isPhaseModulated);
                    }
                }
                else
                {
                    const bool hasVibrato = false;
                    // inner check
                    if (slot->bit_trem) // all slots can have tremolo
                    {
                        const  bool hasTremolo = true;
                        OPL2_SlotGenerateParametric(slot, buffer, modBuffer, numsamples, hasFeedback, hasVibrato, hasTremolo, isModulator, isPhaseModulated);
                    }
                    else
                    {
                        const  bool hasTremolo = false;
                        OPL2_SlotGenerateParametric(slot, buffer, modBuffer, numsamples, hasFeedback, hasVibrato, hasTremolo, isModulator, isPhaseModulated);
                    }
                }
            }
            else
            {
                const bool isModulator = false;
                const bool isPhaseModulated = false;        // algorithm 0 AM
                const bool hasFeedback = false;             // slot never has feedback
                if (slot->bit_vib)                          // all slots can have vibrato
                {
                    const bool hasVibrato = true;
                    // inner check
                    if (slot->bit_trem) // all slots can have tremolo
                    {
                        const  bool hasTremolo = true;
                        OPL2_SlotGenerateParametric(slot, buffer, modBuffer, numsamples, hasFeedback, hasVibrato, hasTremolo, isModulator, isPhaseModulated);
                    }
                    else
                    {
                        const  bool hasTremolo = false;
                        OPL2_SlotGenerateParametric(slot, buffer, modBuffer, numsamples, hasFeedback, hasVibrato, hasTremolo, isModulator, isPhaseModulated);
                    }
                }
                else
                {
                    const bool hasVibrato = false;
                    // inner check
                    if (slot->bit_trem) // all slots can have tremolo
                    {
                        const  bool hasTremolo = true;
                        OPL2_SlotGenerateParametric(slot, buffer, modBuffer, numsamples, hasFeedback, hasVibrato, hasTremolo, isModulator, isPhaseModulated);
                    }
                    else
                    {
                        const  bool hasTremolo = false;
                        OPL2_SlotGenerateParametric(slot, buffer, modBuffer, numsamples, hasFeedback, hasVibrato, hasTremolo, isModulator, isPhaseModulated);
                    }
                }
            }
        }
        //
    }
    chip->tremolopos += numsamples * (1 << TREMOLO_PRECISION ) * (conversionFactor * 256.0f / 210.0f);
    chip->timerFixedPoint += numsamples * (1 << CHIP_TIMER_FIXED_POINT_FRACT_BITS) * conversionFactor;
}

static void OPL2_EnvelopeKeyOn(opl2_slot *slot)
{
#if KEYBOARD_ON_MODE2
    if (!slot->key)
    {
        slot->pg_phase = 0;
        // instant attack?
        if (((slot->ks + (slot->bits_ar << 2)) >> 2) >= 0xf)// rate_hi == 0x0f)
        {
            #if OPL_NO_FLOAT
            slot->eg_rout = 0x00;
            #else
            slot->eg_rout_f = 0x00;

            #endif
        slot->eg_gen = envelope_gen_num_decay;
        }
        else
        {
            slot->eg_gen = envelope_gen_num_attack;
        }
    }
#endif
    slot->key = 1;
}

static void OPL2_EnvelopeKeyOff(opl2_slot *slot)
{
#if KEYBOARD_ON_MODE2
    if (slot->key)
        slot->eg_gen = envelope_gen_num_release;
#endif
    slot->key = 0;
}



//
// Slot
//

static void OPL2_SlotWrite20(opl2_slot *slot, Bit8u data)
{
   /* if ((data >> 7) & 0x01)
    {
        slot->trem = &slot->chip->tremolo;
    }
    else
    {
        slot->trem = (Bit8u*)&slot->chip->zeromod;
    }*/
    slot->bit_trem = ((data >> 7) & 0x01);
    slot->bit_vib = (data >> 6) & 0x01;
    slot->bit_sustain = (data >> 5) & 0x01;
    slot->bit_ksr = (data >> 4) & 0x01;
    slot->bits_mult = data & 0x0f;
    OPL2_EnvelopeUpdateKSL(slot);
}

static void OPL2_SlotWrite40(opl2_slot *slot, Bit8u data)
{
    slot->bits_ksl = (data >> 6) & 0x03;
    slot->bits_tl = data & 0x3f;
    OPL2_EnvelopeUpdateKSL(slot);
}

static void OPL2_SlotWrite60(opl2_slot *slot, Bit8u data)
{
    slot->bits_ar = (data >> 4) & 0x0f;
    slot->bits_dr = data & 0x0f;
}

static void OPL2_SlotWrite80(opl2_slot *slot, Bit8u data)
{
    slot->bits_sl = (data >> 4) & 0x0f;
    if (slot->bits_sl == 0x0f)
    {
        slot->bits_sl = 0x1f;
    }
    slot->bits_rr = data & 0x0f;
}

static void OPL2_SlotWriteE0(opl2_slot *slot, Bit8u data)
{
    slot->reg_wf = data & 0x03;
    #if BETTER_COMPATIBILTIY
    slot->waveformMod = waveMask[slot->reg_wf];
    #else
    slot->waveformMod = waveMult[slot->reg_wf];
    #endif
}

//
// Channel
//


static void  updateSlotVibTable(opl2_channel *channel, uint8_t vibdepth)
{
    uint16_t f_num =  channel->f_num;
    channel->slots[0]->vib_table = pm_tables[vibdepth][(f_num >> 7) & 7];
    channel->slots[1]->vib_table = pm_tables[vibdepth][(f_num >> 7) & 7];
}
static void OPL2_ChannelWriteA0(opl2_channel *channel, Bit8u data)
{
    channel->f_num = (channel->f_num & 0x300) | data;
    channel->ksv = (channel->block << 1)
                 | ((channel->f_num >> (0x09 - chip->nts)) & 0x01);
    updateSlotVibTable(channel, chip->vibshift ^ 1);
    OPL2_EnvelopeUpdateKSL(channel->slots[0]);
    OPL2_EnvelopeUpdateKSL(channel->slots[1]);

}

static void OPL2_ChannelWriteB0(opl2_channel *channel, Bit8u data)
{
    channel->f_num = (channel->f_num & 0xff) | ((data & 0x03) << 8);
    channel->block = (data >> 2) & 0x07;
    channel->ksv = (channel->block << 1)
                 | ((channel->f_num >> (0x09 - chip->nts)) & 0x01);
    updateSlotVibTable(channel, chip->vibshift ^ 1);
    OPL2_EnvelopeUpdateKSL(channel->slots[0]);
    OPL2_EnvelopeUpdateKSL(channel->slots[1]);

}

static void OPL2_ChannelWriteC0(opl2_channel *channel, Bit8u data)
{
//    channel->fb = (data & 0x0e) >> 1;
    channel->nineMinusFb = 9 - ((data & 0x0e) >> 1);
    channel->con = data & 0x01;
    channel->alg = channel->con;
}

static void OPL2_ChannelKeyOn(opl2_channel *channel)
{
    OPL2_EnvelopeKeyOn(channel->slots[0]);
    OPL2_EnvelopeKeyOn(channel->slots[1]);
}

static void OPL2_ChannelKeyOff(opl2_channel *channel)
{
    OPL2_EnvelopeKeyOff(channel->slots[0]);
    OPL2_EnvelopeKeyOff(channel->slots[1]);
}
void OPL2_Reset(Bit32u samplerate)
{
    (void ) samplerate;
    Bit8u slotnum;
    Bit8u channum;

    memset(chip, 0, sizeof(opl2_chip));
    for (slotnum = 0; slotnum < OPL_NUM_OPERATORS; slotnum++)
    {
        chip->slot[slotnum].eg_rout_f = 0x1ff;
        // chip->slot[slotnum].eg_out = 0x1ff;
        chip->slot[slotnum].eg_gen = envelope_gen_num_release;
    }
    chip->vibshift = 1;
    for (channum = 0; channum < OPL_NUM_VOICES; channum++)
    {
        chip->channel[channum].slots[0] = &chip->slot[2 * channum];
        chip->channel[channum].slots[1] = &chip->slot[2 * channum + 1];
        chip->channel[channum].slots[0]->chanNum = channum;
        chip->channel[channum].slots[1]->chanNum = channum;
        updateSlotVibTable(&chip->channel[channum], chip->vibshift ^ 1);
    }
}

void OPL2_WriteRegister(uint16_t reg, uint8_t v)
{
//    printf("Write reg %x value %x\r\n",reg, v);
//    Bit8u high = (reg >> 8) & 0x01;
    if (reg >> 8)
        return;
    Bit8u regm = reg & 0xff;
    switch (regm & 0xf0)
    {
    case 0x00:

        switch (regm & 0x0f)
        {
        case 0x08:
            chip->nts = (v >> 6) & 0x01;
            break;
        }
    break;
    case 0x20:
    case 0x30:
        if (ad_slot[regm & 0x1f] >= 0)
        {
            OPL2_SlotWrite20(&chip->slot[ad_slot[regm & 0x1f]], v);
        }
        break;
    case 0x40:
    case 0x50:
        if (ad_slot[regm & 0x1f] >= 0)
        {
            OPL2_SlotWrite40(&chip->slot[ad_slot[regm & 0x1f]], v);
        }
        break;
    case 0x60:
    case 0x70:
        if (ad_slot[regm & 0x1f] >= 0)
        {
            OPL2_SlotWrite60(&chip->slot[ad_slot[regm & 0x1f]], v);
        }
        break;
    case 0x80:
    case 0x90:
        if (ad_slot[regm & 0x1f] >= 0)
        {
            OPL2_SlotWrite80(&chip->slot[ad_slot[regm & 0x1f]], v);
        }
        break;
    case 0xe0:
    case 0xf0:
        if (ad_slot[regm & 0x1f] >= 0)
        {
            OPL2_SlotWriteE0(&chip->slot[ad_slot[regm & 0x1f]], v);
        }
        break;
    case 0xa0:
        if ((regm & 0x0f) < 9)
        {
            OPL2_ChannelWriteA0(&chip->channel[(regm & 0x0f)], v);
        }
        break;
    case 0xb0:
        if (regm == 0xbd)
        {
            //chip->tremoloshift = (((v >> 7) ^ 1) << 1) + 2;
            chip->tremoloTable = resampled_lfo[(v >> 7) &  1];
            chip->vibshift = ((v >> 6) & 0x01) ^ 1;
            for (int channum = 0; channum < OPL_NUM_VOICES; channum++)
            {
                updateSlotVibTable(&chip->channel[channum], chip->vibshift ^ 1);
            }
        }
        else if ((regm & 0x0f) < 9)
        {
            OPL2_ChannelWriteB0(&chip->channel[(regm & 0x0f)], v);
            if (v & 0x20)
            {
                OPL2_ChannelKeyOn(&chip->channel[(regm & 0x0f)]);
            }
            else
            {
                OPL2_ChannelKeyOff(&chip->channel[(regm & 0x0f)]);
            }
        }
        break;
    case 0xc0:
        if ((regm & 0x0f) < 9)
        {
            OPL2_ChannelWriteC0(&chip->channel[(regm & 0x0f)], v);
        }
        break;
    }
}
